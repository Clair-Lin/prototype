<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ•°å­—æ°´å°ç³»ç»Ÿ - åŸå‹</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: '#eff6ff',
                100: '#dbeafe',
                200: '#bfdbfe',
                300: '#93c5fd',
                400: '#60a5fa',
                500: '#3b82f6',
                600: '#2563eb',
                700: '#1d4ed8',
                800: '#1e40af',
                900: '#1e3a8a'
              }
            },
            boxShadow: {
              card: '0 8px 30px rgba(0,0,0,0.06)'
            }
          }
        }
      }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Fallback if CDN fails -->
    <noscript>
      <style>
        .fa-solid, .fa-regular, .fa-brands { display: inline-block; width: 1em; height: 1em; }
        .fa-th-large::before { content: "â˜°"; }
        .fa-shield-check::before { content: "âœ“"; }
        .fa-bars::before { content: "â˜°"; }
        .fa-key::before { content: "ğŸ”‘"; }
        .fa-bell::before { content: "ğŸ””"; }
        .fa-gear::before { content: "âš™"; }
        .fa-user::before { content: "ğŸ‘¤"; }
        .fa-chevron-down::before { content: "âŒ„"; }
      </style>
    </noscript>
    <style>
      /* Smoothly hide/show views */
      .view { display: none; }
      .view.active { display: block; }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      /* Top nav active state */
      .top-nav-btn.active {
        background-color: rgba(255,255,255,0.2);
        font-weight: 500;
      }
      /* Ensure icons are visible */
      .fa-solid, .fa-regular, .fa-brands {
        display: inline-block;
        font-style: normal;
        font-variant: normal;
        text-rendering: auto;
        line-height: 1;
        font-family: "Font Awesome 6 Free", "Font Awesome 6 Pro", "Font Awesome 6 Brands", sans-serif;
      }
      /* Ensure top menu icons are visible and styled consistently */
      header .top-menu-icon {
        color: white !important;
        font-weight: 400;
        opacity: 1 !important;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        display: inline-block !important;
        font-size: 1.25rem;
      }
      /* Ensure Font Awesome icons load properly */
      header i.fa-solid,
      header i.fa-regular {
        font-family: "Font Awesome 6 Free" !important;
        font-weight: 900 !important;
      }
      /* Fallback if FontAwesome fails to load */
      .fa-th-large:not([class*="fa-"])::before,
      .fa-th-large[style*="display: none"]::before {
        content: "â˜°";
        font-family: sans-serif;
      }
      .fa-shield-check:not([class*="fa-"])::before,
      .fa-shield-check[style*="display: none"]::before,
      .fa-shield-halved:not([class*="fa-"])::before,
      .fa-shield-halved[style*="display: none"]::before {
        content: "ğŸ›¡";
        font-family: sans-serif;
        font-size: 1.2em;
      }
      /* Ensure shield icon is visible */
      .fa-shield-halved {
        font-weight: 900;
      }
      /* Icon button hover effects */
      header button:hover {
        transform: scale(1.05);
        transition: transform 0.2s;
      }
      /* Dropdown menu animation */
      #menuGridDropdown {
        animation: fadeIn 0.2s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Menu item hover effect */
      .menu-item:hover {
        background-color: #f3f4f6 !important;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- Error overlay (shows JS runtime errors for easier debugging) -->
    <div id="errorOverlay" class="hidden fixed inset-4 z-50 flex items-start justify-center p-4">
      <div class="bg-red-50 border border-red-200 text-red-900 rounded shadow-lg w-full max-w-3xl p-4">
        <div class="flex items-start justify-between">
          <div class="font-semibold">è¿è¡Œæ—¶é”™è¯¯</div>
          <button id="errorOverlayClose" class="text-red-700">å…³é—­</button>
        </div>
        <pre id="errorOverlayMsg" class="whitespace-pre-wrap mt-2 text-sm"></pre>
      </div>
    </div>
    <!-- App Shell -->
    <div class="min-h-screen flex flex-col">
      <!-- Top Bar -->
      <header class="h-14 bg-primary-600 text-white flex items-center justify-between px-4 shadow">
        <!-- Left: Platform Title -->
        <div class="flex items-center gap-3 font-semibold tracking-wide">
          <button id="sidebarToggle" class="lg:hidden p-2 rounded hover:bg-primary-700 focus:outline-none mr-2" aria-label="Toggle Sidebar">
            <i class="fa-solid fa-border-all text-xl"></i>
          </button>
          <span>æ•°æ®è„±æ•ä¸æº¯æºå¹³å°</span>
        </div>
        <!-- Right: All Icons -->
        <div class="flex items-center gap-2">
          <!-- Grid Icon with Dropdown -->
          <div class="relative">
            <button id="menuGridBtn" class="p-2 rounded hover:bg-primary-700 transition-colors relative">
              <i class="fa-solid fa-bars text-xl top-menu-icon"></i>
            </button>
            <!-- Dropdown Menu -->
            <div id="menuGridDropdown" class="absolute right-0 mt-2 w-56 bg-white rounded shadow-lg border border-gray-200 hidden z-50">
              <div class="py-1">
                <a href="javascript:void(0)" class="menu-item flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 text-gray-700 text-sm transition-colors">
                  <i class="fa-solid fa-th-large text-gray-500 w-5"></i>
                  <span>æ§åˆ¶å°ä¸»é¡µ</span>
                </a>
                <a href="javascript:void(0)" class="menu-item flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 text-gray-700 text-sm transition-colors">
                  <i class="fa-solid fa-shield-check text-gray-500 w-5"></i>
                  <span>é™æ€æ•°æ®è„±æ•</span>
                </a>
                <a href="javascript:void(0)" class="menu-item flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 text-gray-700 text-sm transition-colors">
                  <i class="fa-solid fa-bolt text-gray-500 w-5"></i>
                  <span>åŠ¨æ€æ•°æ®è„±æ•</span>
                </a>
                <a href="javascript:void(0)" data-module="watermark" class="menu-item flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 text-gray-700 text-sm transition-colors">
                  <i class="fa-solid fa-pen text-gray-500 w-5"></i>
                  <span>æ°´å°ä¸æº¯æºæœåŠ¡</span>
                </a>
                <a href="javascript:void(0)" data-module="asset" class="menu-item flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 text-gray-700 text-sm transition-colors">
                  <i class="fa-solid fa-folder-open text-gray-500 w-5"></i>
                  <span>èµ„äº§ç®¡ç†</span>
                </a>
                <a href="javascript:void(0)" class="menu-item flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 text-gray-700 text-sm transition-colors">
                  <i class="fa-solid fa-link text-gray-500 w-5"></i>
                  <span>æ¶‰æ•ä¸šåŠ¡</span>
                </a>
              </div>
            </div>
          </div>
          <!-- Shield Icon - Rules Library Entry -->
          <button id="shieldRulesBtn" data-module="rules" class="p-2 rounded hover:bg-primary-700 transition-colors" title="è§„åˆ™åº“">
            <i class="fa-solid fa-shield text-xl top-menu-icon"></i>
          </button>
          <!-- Key Icon -->
          <button class="p-2 rounded hover:bg-primary-700 transition-colors" title="å¯†é’¥åº“">
            <i class="fa-solid fa-key text-xl top-menu-icon"></i>
          </button>
          <!-- Notification Icon with Badge -->
          <button class="p-2 rounded hover:bg-primary-700 transition-colors relative">
            <i class="fa-solid fa-bell text-xl top-menu-icon"></i>
            <span class="absolute -top-0.5 -right-0.5 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs text-white font-semibold">1</span>
          </button>
          <!-- Settings Icon -->
          <button class="p-2 rounded hover:bg-primary-700 transition-colors">
            <i class="fa-solid fa-gear text-xl top-menu-icon"></i>
          </button>
          <!-- User Menu -->
          <div class="relative">
            <button id="userMenuBtn" class="flex items-center gap-2 px-2 py-1 rounded hover:bg-primary-700 transition-colors">
              <div class="w-8 h-8 rounded-full bg-white/20 grid place-items-center">
                <i class="fa-regular fa-user text-sm"></i>
              </div>
              <span class="text-sm">admin</span>
              <i class="fa-solid fa-chevron-down text-xs"></i>
            </button>
          </div>
        </div>
      </header>

      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar - Dynamic based on module -->
        <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 p-3 space-y-4 overflow-y-auto transition-all duration-200 hidden lg:block">
          <!-- Watermark Service Sidebar -->
          <div id="sidebar-watermark" class="sidebar-module">
            <div class="px-3 py-2 text-sm font-medium text-gray-700 flex items-center justify-between">
              <span>æ°´å°ä¸æº¯æºæœåŠ¡</span>
              <button class="lg:hidden p-1 rounded hover:bg-gray-100">
                <i class="fa-solid fa-bars text-xs"></i>
              </button>
            </div>
            <nav class="space-y-1 mt-2">
              <a data-module="watermark" data-page="home" class="nav-link flex items-center gap-2 px-3 py-2 rounded hover:bg-primary-50 hover:text-primary-700 cursor-pointer">
                <i class="fa-solid fa-house"></i>
                <span>æ¦‚è§ˆ</span>
              </a>
              <a data-module="watermark" data-page="strategy" class="nav-link flex items-center gap-2 px-3 py-2 rounded hover:bg-primary-50 hover:text-primary-700 cursor-pointer">
                <i class="fa-solid fa-sitemap"></i>
                <span>æ¥å…¥ä¸šåŠ¡æ°´å°</span>
              </a>
              <a data-module="watermark" data-page="trace" class="nav-link flex items-center gap-2 px-3 py-2 rounded hover:bg-primary-50 hover:text-primary-700 cursor-pointer">
                <i class="fa-solid fa-magnifying-glass"></i>
                <span>æ°´å°æº¯æº</span>
              </a>
            </nav>
          </div>
          <!-- Asset Management Sidebar -->
          <div id="sidebar-asset" class="sidebar-module hidden">
            <div class="px-3 py-2 text-sm font-medium text-gray-700 flex items-center justify-between">
              <span>èµ„äº§ç®¡ç†</span>
              <button class="lg:hidden p-1 rounded hover:bg-gray-100">
                <i class="fa-solid fa-bars text-xs"></i>
              </button>
            </div>
            <nav class="space-y-1 mt-2">
              <a data-module="asset" data-page="access" class="nav-link flex items-center gap-2 px-3 py-2 rounded hover:bg-primary-50 hover:text-primary-700 cursor-pointer">
                <i class="fa-solid fa-plug"></i>
                <span>æ¥å…¥ä¸šåŠ¡</span>
              </a>
            </nav>
          </div>
          <!-- Rules Library Sidebar -->
          <div id="sidebar-rules" class="sidebar-module hidden">
            <div class="px-3 py-2 text-sm font-medium text-gray-700 flex items-center justify-between">
              <span>è§„åˆ™åº“</span>
              <button class="lg:hidden p-1 rounded hover:bg-gray-100">
                <i class="fa-solid fa-bars text-xs"></i>
              </button>
            </div>
            <nav class="space-y-1 mt-2">
              <a data-module="rules" data-page="library" class="nav-link flex items-center gap-2 px-3 py-2 rounded hover:bg-primary-50 hover:text-primary-700 cursor-pointer">
                <i class="fa-solid fa-book"></i>
                <span>è§„åˆ™åº“</span>
              </a>
              <a data-module="rules" data-page="watermark-lib" class="nav-link flex items-center gap-2 px-3 py-2 rounded hover:bg-primary-50 hover:text-primary-700 cursor-pointer">
                <i class="fa-solid fa-water"></i>
                <span>æ°´å°è§„åˆ™åº“</span>
              </a>
              <a data-module="rules" data-page="templates" class="nav-link flex items-center gap-2 px-3 py-2 rounded hover:bg-primary-50 hover:text-primary-700 cursor-pointer">
                <i class="fa-regular fa-rectangle-list"></i>
                <span>è§„åˆ™æ¨¡ç‰ˆ</span>
              </a>
            </nav>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 lg:p-6 space-y-6">
          <!-- Home Overview -->
          <section id="view-home" class="view">
            <div class="flex items-center justify-between">
              <h1 class="text-xl lg:text-2xl font-semibold">æ°´å°ä¸æº¯æºæœåŠ¡æ¦‚è§ˆ</h1>
              <div class="flex gap-2">
                <button class="px-3 py-2 rounded bg-primary-600 text-white hover:bg-primary-700 text-sm"><i class="fa-solid fa-arrow-rotate-right mr-2"></i>åˆ·æ–°</button>
                <button class="px-3 py-2 rounded border text-sm"><i class="fa-regular fa-circle-question mr-2"></i>å¸®åŠ©</button>
              </div>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mt-4">
              <!-- Stats Cards -->
              <div class="bg-white rounded-lg shadow-card p-4">
                <div class="text-gray-500 text-sm">æ•°æ®æº</div>
                <div class="mt-2 flex items-end justify-between">
                  <div class="text-3xl font-bold">12</div>
                  <i class="fa-solid fa-database text-primary-600 text-2xl"></i>
                </div>
                <div class="text-xs text-gray-500 mt-1">å·²é…ç½®çš„æ•°æ®æºæ•°é‡</div>
              </div>
              <div class="bg-white rounded-lg shadow-card p-4">
                <div class="text-gray-500 text-sm">æ°´å°ç­–ç•¥</div>
                <div class="mt-2 flex items-end justify-between">
                  <div class="text-3xl font-bold">8</div>
                  <i class="fa-solid fa-diagram-project text-primary-600 text-2xl"></i>
                </div>
                <div class="text-xs text-gray-500 mt-1">å·²é…ç½®çš„æ°´å°ç­–ç•¥æ•°é‡</div>
              </div>
              <div class="bg-white rounded-lg shadow-card p-4">
                <div class="text-gray-500 text-sm">æº¯æºè®°å½•</div>
                <div class="mt-2 flex items-end justify-between">
                  <div class="text-3xl font-bold">156</div>
                  <i class="fa-solid fa-flask text-primary-600 text-2xl"></i>
                </div>
                <div class="text-xs text-gray-500 mt-1">ä»Šæ—¥æº¯æºè®°å½•æ•°é‡</div>
              </div>
            </div>

            <div class="bg-white rounded-lg mt-6 shadow-card">
              <div class="p-4 border-b flex items-center gap-2 text-gray-700 text-sm">
                <i class="fa-solid fa-circle-info text-primary-600"></i>
                æœåŠ¡çŠ¶æ€
              </div>
              <div class="grid md:grid-cols-3 gap-4 p-4">
                <div class="flex items-center gap-3 p-3 border rounded">
                  <span class="w-8 h-8 rounded bg-green-100 text-green-600 grid place-items-center"><i class="fa-solid fa-check"></i></span>
                  <div>
                    <div class="font-medium">æ°´å°æœåŠ¡</div>
                    <div class="text-xs text-gray-500">è¿è¡Œæ­£å¸¸</div>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 border rounded">
                  <span class="w-8 h-8 rounded bg-green-100 text-green-600 grid place-items-center"><i class="fa-solid fa-check"></i></span>
                  <div>
                    <div class="font-medium">æº¯æºæœåŠ¡</div>
                    <div class="text-xs text-gray-500">è¿è¡Œæ­£å¸¸</div>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 border rounded">
                  <span class="w-8 h-8 rounded bg-green-100 text-green-600 grid place-items-center"><i class="fa-solid fa-check"></i></span>
                  <div>
                    <div class="font-medium">æ•°æ®æºè¿æ¥</div>
                    <div class="text-xs text-gray-500">è¿æ¥æ­£å¸¸</div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Strategy Config -->
          <section id="view-strategy" class="view">
            <div class="flex items-start justify-between flex-wrap gap-3">
              <div>
                <h1 class="text-xl lg:text-2xl font-semibold">ç­–ç•¥é…ç½®</h1>
                <p class="text-sm text-gray-500 mt-1">ä¸ºä¸åŒä¸šåŠ¡é…ç½®å·®å¼‚åŒ–æ°´å°ç­–ç•¥ä¸è§„åˆ™</p>
              </div>
              <div class="flex gap-2">
                <button id="btnStrategyGuide" class="px-3 py-2 rounded text-primary-600  hover:bg-primary-50 text-sm">
                  <i class="fa-regular fa-circle-question mr-2"></i>å¿«é€ŸæŒ‡å¼•
                </button>
                <button class="px-3 py-2 rounded border text-sm"><i class="fa-solid fa-cloud-arrow-down mr-2"></i>å¯¼å‡º</button>
              </div>
            </div>
            <!-- ç­–ç•¥ç±»å‹é¡µç­¾ -->
            <div class="mt-4 mb-2">
              <nav class="flex gap-2 text-sm" id="strategyTabs">
                <button data-tab="sdk" class="tab-btn px-4 py-2 rounded bg-primary-50 text-primary-700 border-b-2 border-primary-600">SDKç­–ç•¥</button>
                <button data-tab="jdbc" class="tab-btn px-4 py-2 rounded hover:bg-gray-50">JDBCç­–ç•¥</button>
              </nav>
            </div>
            <!-- ç­–ç•¥åˆ—è¡¨åŒºï¼ˆæŒ‰é¡µç­¾åˆ‡æ¢ï¼‰ -->
            <div id="strategyListArea">
              <!-- æ–°å¢ç­–ç•¥æŒ‰é’®åœ¨å½“å‰é¡µç­¾ä¸‹æ–¹ -->
              <div class="flex items-center justify-start mb-4">
                <button id="btnAddStrategy" class="px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700 text-sm">
                  <i class="fa-solid fa-plus mr-2"></i>æ–°å¢ç­–ç•¥
                </button>
              </div>
              <div class="bg-white rounded-lg shadow-card">
                <div class="p-4 border-b font-medium">ç­–ç•¥åˆ—è¡¨</div>
                <div class="p-4">
                  <div id="strategyList" class="space-y-3"></div>
                </div>
              </div>
            </div>
          </section>

          <!-- Trace -->
          <section id="view-trace" class="view">
            <div class="flex items-start justify-between flex-wrap gap-3">
              <div>
                <h1 class="text-xl lg:text-2xl font-semibold">æ°´å°æº¯æº</h1>
                <p class="text-sm text-gray-500 mt-1">ä¸Šä¼ æ–‡ä»¶æˆ–æˆªå›¾ï¼Œè¿›è¡Œæ°´å°æº¯æºåˆ†æ</p>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-card p-4 mt-4">
              <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="flex items-center gap-2 w-full sm:w-auto sm:flex-1">
                  <input id="traceFile" type="file" class="hidden" />
                  <div class="flex-1 border rounded px-3 py-2 bg-white cursor-pointer hover:border-primary-500 transition-colors" id="traceFileBrowse">
                    <div class="flex items-center justify-between">
                      <span id="traceFileName" class="text-sm text-gray-500 truncate">è¯·é€‰æ‹©æ–‡ä»¶</span>
                      <i class="fa-solid fa-folder-open text-gray-400 ml-2"></i>
                    </div>
                  </div>
                </div>
                <button id="btnDoTrace" class="px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700 text-sm whitespace-nowrap w-full sm:w-auto"><i class="fa-solid fa-magnifying-glass mr-2"></i>å¼€å§‹æº¯æº</button>
              </div>
              
              <!-- æº¯æºç»“æœæ¨¡å— -->
              <div id="traceResult" class="mt-6">
                <div class="border-t pt-4">
                  <div class="font-medium mb-4 text-gray-700">æº¯æºç»“æœ</div>
                  <div id="traceResultContent" class="bg-white rounded-lg border border-gray-200 p-5">
                    <div id="traceResultEmpty" class="text-center text-gray-400 py-8">
                      <i class="fa-solid fa-inbox text-4xl mb-3"></i>
                      <p>æš‚æ— æº¯æºç»“æœ</p>
                    </div>
                    <div id="traceResultData" class="hidden">
                      <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
                        <i class="fa-solid fa-circle-check text-green-600"></i>
                        <span class="font-medium text-gray-700">æ£€æµ‹çŠ¶æ€ï¼š</span>
                        <span class="text-green-600 font-semibold" id="traceResultStatus">æ£€æµ‹åˆ°æœ‰æ•ˆæ°´å°</span>
                      </div>
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex items-start gap-2">
                          <span class="text-gray-500 min-w-[100px]">æ¥æºä¸šåŠ¡ï¼š</span>
                          <span class="font-medium text-gray-800" id="traceResultSource">-</span>
                        </div>
                        <div class="flex items-start gap-2">
                          <span class="text-gray-500 min-w-[100px]">æ°´å°ç­–ç•¥ï¼š</span>
                          <span class="font-medium text-gray-800" id="traceResultStrategy">-</span>
                        </div>
                        <div class="flex items-start gap-2">
                          <span class="text-gray-500 min-w-[100px]">æ°´å°ç±»å‹ï¼š</span>
                          <span class="font-medium text-gray-800" id="traceResultWatermarkType">-</span>
                        </div>
                        <div class="flex items-start gap-2">
                          <span class="text-gray-500 min-w-[100px]">æ°´å°æ—¥æœŸï¼š</span>
                          <span class="font-medium text-gray-800" id="traceResultWatermarkDate">-</span>
                        </div>
                        <div class="flex items-start gap-2 sm:col-span-2">
                          <span class="text-gray-500 min-w-[100px]">æ–‡ä»¶åç§°ï¼š</span>
                          <span class="font-medium text-gray-800 break-words" id="traceResultFileName">-</span>
                        </div>
                        <div class="flex items-start gap-2 sm:col-span-2">
                          <span class="text-gray-500 min-w-[100px]">æ°´å°å†…å®¹ï¼š</span>
                          <div class="flex-1">
                            <div class="bg-gray-50 rounded-lg p-4 space-y-2 border border-gray-100">
                              <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-sm">IPåœ°å€ï¼š</span>
                                <span class="font-medium text-gray-800 text-sm" id="traceResultIP">-</span>
                              </div>
                              <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-sm">ç”¨æˆ·åï¼š</span>
                                <span class="font-medium text-gray-800 text-sm" id="traceResultUser">-</span>
                              </div>
                              <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-sm">æ—¶é—´æˆ³ï¼š</span>
                                <span class="font-medium text-gray-800 text-sm" id="traceResultTimestamp">-</span>
                              </div>
                              <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-sm">æº¯æºæ ‡è¯†ï¼š</span>
                                <span class="font-medium text-gray-800 text-sm" id="traceResultTraceId">-</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-card mt-6">
              <div class="p-4 border-b font-medium">æº¯æºè®°å½•</div>
              <div class="p-4 overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead>
                    <tr class="text-left text-gray-500">
                      <th class="py-2 pr-4">æ—¶é—´</th>
                      <th class="py-2 pr-4">æ–‡ä»¶å</th>
                      <th class="py-2 pr-4">ç»“æœ</th>
                      <th class="py-2 pr-4">æ¥æºä¸šåŠ¡</th>
                      <th class="py-2 pr-4">ç­–ç•¥</th>
                      <th class="py-2 pr-4">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="traceHistory"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Asset Management - Access Businesses -->
          <section id="view-asset-access" class="view">
            <div class="flex items-start justify-between flex-wrap gap-3">
              <div>
                <h1 class="text-xl lg:text-2xl font-semibold">æ¥å…¥ä¸šåŠ¡</h1>
                <p class="text-sm text-gray-500 mt-1">ç®¡ç†å’Œé…ç½®éœ€è¦æ¥å…¥çš„ä¸šåŠ¡ç³»ç»Ÿ,ç»Ÿä¸€ä¸šåŠ¡æ¥å…¥æµç¨‹ã€‚</p>
              </div>
              <div class="flex gap-2">
                <button id="btnAssetGuide" class="px-3 py-2 rounded text-primary-600 hover:bg-primary-50 text-sm"><i class="fa-regular fa-circle-question mr-2"></i>å¿«é€ŸæŒ‡å¼•</button>
                <div class="relative">
                  <button id="sdkDropdownBtn" class="px-3 py-2 rounded border text-sm"><i class="fa-solid fa-download mr-2"></i>SDK ä¸‹è½½</button>
                  <div id="sdkDropdown" class="absolute right-0 mt-2 w-44 bg-white border rounded shadow hidden">
                    <a class="block px-3 py-2 hover:bg-gray-50" href="javascript:void(0)">Java SDK</a>
                    <a class="block px-3 py-2 hover:bg-gray-50" href="javascript:void(0)">Node.js SDK</a>
                    <a class="block px-3 py-2 hover:bg-gray-50" href="javascript:void(0)">Python SDK</a>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between mt-4 mb-4">
              <div class="flex items-center gap-2">
                <button id="btnAddBusiness" class="px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700 text-sm">
                  <i class="fa-solid fa-plus mr-2"></i>æ–°å¢ä¸šåŠ¡
                </button>
                <!-- <button class="p-2 rounded border hover:bg-gray-50">
                  <i class="fa-solid fa-rotate"></i>
                </button> -->
                <div class="relative">
                  <input type="text" placeholder="æœç´¢ä¸šåŠ¡åç§°ã€æè¿°" class="pl-10 pr-4 py-2 border rounded text-sm w-64" />
                  <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-card mt-6">
              <div class="p-4 border-b font-medium">ä¸šåŠ¡åˆ—è¡¨</div>
              <div class="p-4 overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead>
                    <tr class="text-left text-gray-500 border-b">
                      <th class="py-2 pr-4">ä¸šåŠ¡åç§°</th>
                      <th class="py-2 pr-4">æè¿°</th>
                      <th class="py-2 pr-4">æ¥å…¥çŠ¶æ€</th>
                      <th class="py-2 pr-4">å‡­è¯</th>
                      <th class="py-2 pr-4">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="assetTable"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Rules Library -->
          <section id="view-rules-library" class="view">
            <div>
              <h1 class="text-2xl lg:text-3xl font-semibold mb-2">è§„åˆ™åº“</h1>
              <p class="text-sm text-gray-600 mb-3">ç®¡ç†å¹³å°å†…ç½®å’Œè‡ªå®šä¹‰çš„è„±æ•è§„åˆ™ã€æ•æ„Ÿå†…å®¹è¯†åˆ«è§„åˆ™</p>
              <div class="flex items-center gap-4 text-sm text-gray-600 mb-4">
                <span>ç‰ˆæœ¬:v1.2.3 (2024-07-21)</span>
                <a href="javascript:void(0)" class="text-primary-600 hover:underline">æ£€æŸ¥æ›´æ–°</a>
                <a href="javascript:void(0)" class="text-primary-600 hover:underline">ç¦»çº¿å¯¼å…¥</a>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-card mt-4">
              <div class="p-3 border-b">
                <nav class="flex flex-wrap gap-2 text-sm" id="rulesTabs">
                  <button data-tab="rules-audit" class="tab-btn px-4 py-2 rounded hover:bg-gray-50 transition-colors">è¯†åˆ«ä¸è„±æ•è§„åˆ™åº“</button>
                  <button data-tab="rules-watermark" class="tab-btn px-4 py-2 rounded hover:bg-gray-50 transition-colors">æ°´å°è§„åˆ™åº“</button>
                  <button data-tab="rules-templates" class="tab-btn px-4 py-2 rounded bg-primary-50 text-primary-700 border-b-2 border-primary-600 transition-colors">è§„åˆ™æ¨¡ç‰ˆ</button>
                  <button data-tab="rules-dict" class="tab-btn px-4 py-2 rounded hover:bg-gray-50 transition-colors">ç‰¹å¾å­—å…¸åº“</button>
                  <button data-tab="rules-canvas" class="tab-btn px-4 py-2 rounded hover:bg-gray-50 transition-colors">ç®—å­ç”»å¸ƒ</button>
                </nav>
              </div>
              <div class="p-4">
                <!-- Tab content will be dynamically loaded -->
                <div id="rulesTabContent" class="text-sm text-gray-600">
                  <!-- Content for rules-templates tab -->
                  <div id="rules-templates-content" class="grid lg:grid-cols-3 gap-6">
                    <!-- Left: Template List -->
                    <div class="bg-gray-50 rounded-lg p-4">
                          <div class="flex items-center justify-between mb-3">
                                <h3 class="font-medium">æ¨¡ç‰ˆåˆ—è¡¨</h3>
                                <button id="btnAddTemplateInTab" class="px-3 py-1.5 rounded bg-primary-600 text-white hover:bg-primary-700 text-sm">
                                  <i class="fa-solid fa-plus mr-1"></i>æ–°å¢æ¨¡ç‰ˆ
                                </button>
                              </div>
                      <div class="relative mb-3 flex items-center gap-2">
                        <div class="relative flex-1">
                          <input id="templateSearchInput" type="text" placeholder="æœç´¢æ¨¡ç‰ˆ" class="w-full border rounded px-3 py-2 pl-9 text-sm" />
                          <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <select id="templateSortSelect" class="border rounded px-2 py-2 text-sm">
                          <option value="name-asc">åç§° â†‘</option>
                          <option value="name-desc">åç§° â†“</option>
                          <option value="source-asc">æ¥æº â†‘</option>
                          <option value="source-desc">æ¥æº â†“</option>
                        </select>
                      </div>
          <div id="templateList" class="space-y-2 max-h-[500px] overflow-y-auto">
            <button class="w-full text-left px-3 py-2 rounded bg-white hover:bg-gray-100 border border-gray-200 transition-colors">
                          <div class="font-medium text-sm">å®¢æœç³»ç»Ÿæ¨¡ç‰ˆ</div>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded bg-white hover:bg-gray-100 border border-gray-200 transition-colors">
                          <div class="font-medium text-sm">è®¡è´¹ç³»ç»Ÿæ¨¡ç‰ˆ</div>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded bg-white hover:bg-gray-100 border border-gray-200 transition-colors">
                          <div class="font-medium text-sm">ç½‘ç»œç®¡ç†æ¨¡ç‰ˆ</div>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded bg-white hover:bg-gray-100 border border-gray-200 transition-colors">
                          <div class="font-medium text-sm">è¥é”€ç³»ç»Ÿæ¨¡ç‰ˆ</div>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded bg-white hover:bg-gray-100 border border-gray-200 transition-colors">
                          <div class="font-medium text-sm">æ•°æ®ä»“åº“æ¨¡ç‰ˆ</div>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded bg-white hover:bg-gray-100 border border-gray-200 transition-colors">
                          <div class="font-medium text-sm">æŠ¥è¡¨ç³»ç»Ÿæ¨¡ç‰ˆ</div>
                        </button>
                      </div>
                    </div>
                    <!-- Right: Template Content -->
                    <div class="lg:col-span-2 bg-gray-50 rounded-lg p-4">
                      <div class="flex items-center justify-between mb-4">
                        <h3 class="font-medium">æ¨¡ç‰ˆå†…å®¹</h3>
                        <div class="text-sm text-gray-500" id="templateMetaInTab">æœªé€‰æ‹©æ¨¡ç‰ˆ</div>
                      </div>
                      <div id="templateContentInTab" class="text-sm text-gray-700 min-h-[320px]">
                      <div class="flex items-center justify-center h-64 text-gray-400 text-sm">
                        è¯·é€‰æ‹©å·¦ä¾§æ¨¡ç‰ˆæŸ¥çœ‹è¯¦æƒ…
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Other tab contents will be shown here -->
                </div>
              </div>
            </div>
          </section>

          <!-- Rules - Watermark -->
          <section id="view-rules-watermark-lib" class="view">
            <div class="flex items-start justify-between flex-wrap gap-3">
              <div>
                <h1 class="text-xl lg:text-2xl font-semibold">æ°´å°è§„åˆ™åº“</h1>
                <p class="text-sm text-gray-500 mt-1">ç®¡ç†æ–‡æœ¬/å›¾ç‰‡/æ–‡æ¡£ç­‰ç±»å‹çš„æ°´å°è§„åˆ™</p>
              </div>
              <button id="btnAddWMRule" class="px-3 py-2 rounded bg-primary-600 text-white hover:bg-primary-700 text-sm"><i class="fa-solid fa-plus mr-2"></i>æ–°å¢è§„åˆ™</button>
            </div>

            <div class="bg-white rounded-lg shadow-card mt-4 overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-gray-500">
                    <th class="py-2 pr-4">è§„åˆ™ID</th>
                    <th class="py-2 pr-4">è§„åˆ™åç§°</th>
                    <th class="py-2 pr-4">ç±»å‹</th>
                    <th class="py-2 pr-4">æ°´å°ç®—æ³•</th>
                    <th class="py-2 pr-4">åŠ å¯†ç®—æ³•</th>
                    <th class="py-2 pr-4">æ¥æº</th>
                    <th class="py-2 pr-4">æ›´æ–°æ—¶é—´</th>
                    <th class="py-2 pr-4">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="wmRulesBody"></tbody>
              </table>
            </div>
          </section>

          <!-- Rules - Templates -->
          <section id="view-rules-templates" class="view">
              <div class="flex items-start justify-between flex-wrap gap-3">
              <div>
                <h1 class="text-xl lg:text-2xl font-semibold">è§„åˆ™æ¨¡ç‰ˆ</h1>
                <p class="text-sm text-gray-500 mt-1">å¿«é€Ÿå¤ç”¨å¸¸è§çš„è„±æ•ä¸æ°´å°è§„åˆ™ç»„åˆ</p>
              </div>
              <!-- æ–°å¢è§„åˆ™æŒ‰é’®ä¸ºåªè¯»æ¨¡å¼éšè— -->
              <button id="btnAddTemplateRule" class="px-3 py-2 rounded bg-primary-600 text-white hover:bg-primary-700 text-sm"><i class="fa-solid fa-plus mr-2"></i>æ–°å¢æ¨¡ç‰ˆ</button>
            </div>

            <div class="grid lg:grid-cols-3 gap-6 mt-4">
              <div class="bg-white rounded-lg shadow-card p-0 overflow-hidden">
                <div class="p-3 border-b font-medium">æ¨¡ç‰ˆåˆ—è¡¨</div>
                <div id="templateList" class="p-3 space-y-2 max-h-[480px] overflow-y-auto scrollbar-hide">
                  <!-- templates injected by JS -->
                </div>
              </div>
              <div class="lg:col-span-2 bg-white rounded-lg shadow-card p-0 overflow-hidden">
                <div class="p-3 border-b font-medium flex items-center justify-between">
                  <span>æ¨¡ç‰ˆå†…å®¹</span>
                  <div class="text-sm text-gray-500" id="templateMeta">æœªé€‰æ‹©æ¨¡ç‰ˆ</div>
                </div>
                <div id="templateContent" class="p-4 text-sm text-gray-700 min-h-[320px]">
                  ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ¨¡ç‰ˆä»¥æŸ¥çœ‹è¯¦æƒ…ã€‚
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- Strategy Guide Modal -->
    <div id="strategyGuideModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg w-full max-w-2xl overflow-hidden">
        <div class="p-4 border-b flex items-center justify-between">
          <div class="font-medium">ç­–ç•¥é…ç½® Â· å¿«é€ŸæŒ‡å¼•</div>
          <button class="modal-close text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-4 text-sm leading-6 text-gray-700">
          <ol class="list-decimal ml-5 space-y-2">
            <li>æ–°å¢â€œæ¥å…¥ä¸šåŠ¡â€å¹¶å®Œæˆ SDK/JDBC å¯¹æ¥ã€‚</li>
            <li>åœ¨æœ¬é¡µé¢åˆ›å»ºç­–ç•¥ï¼Œè®¾ç½®ä¼˜å…ˆçº§ã€èŒƒå›´ä¸è§„åˆ™ã€‚</li>
            <li>åœ¨ä¸šåŠ¡ä¾§é›†æˆ SDK å¹¶ä¸‹å‘ç­–ç•¥ ID ç”Ÿæ•ˆã€‚</li>
            <li>é€šè¿‡â€œæ°´å°æº¯æºâ€éªŒè¯ç­–ç•¥æ•ˆæœå¹¶ç•™å­˜å®¡è®¡è®°å½•ã€‚</li>
          </ol>
        </div>
        <div class="p-4 border-t text-right">
          <button class="modal-close px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700">æˆ‘å·²äº†è§£</button>
        </div>
      </div>
    </div>

    <!-- Asset Guide Modal -->
    <div id="assetGuideModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg w-full max-w-xl overflow-hidden">
        <div class="p-4 border-b flex items-center justify-between">
          <div class="font-medium">æ¥å…¥ä¸šåŠ¡ Â· å¿«é€ŸæŒ‡å¼•</div>
          <button class="modal-close text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-4 text-sm leading-6 text-gray-700">
          - é€šè¿‡ SDK æ¥å…¥ï¼šä¸‹è½½å¯¹åº”è¯­è¨€ SDKï¼Œé…ç½®é‰´æƒä¸å›è°ƒã€‚
          <br />
          - é€šè¿‡ JDBC æ¥å…¥ï¼šé…ç½®æ•°æ®åº“è¿æ¥ï¼Œæˆäºˆæ‰€éœ€åªè¯»æƒé™ã€‚
        </div>
        <div class="p-4 border-t text-right">
          <button class="modal-close px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700">çŸ¥é“äº†</button>
        </div>
      </div>
    </div>

    <!-- Trace Detail Modal -->
    <div id="traceDetailModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg w-full max-w-4xl overflow-hidden max-h-[90vh] overflow-y-auto shadow-lg">
        <div class="p-4 border-b flex items-center justify-between bg-white">
          <div class="font-medium text-lg text-gray-800">æº¯æºè¯¦æƒ…</div>
          <button class="modal-close text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="bg-white p-6">
          <div class="flex items-center gap-2 mb-6 pb-4 border-b border-gray-200">
            <i class="fa-solid fa-circle-check text-green-600"></i>
            <span class="font-medium text-gray-700">æ£€æµ‹çŠ¶æ€ï¼š</span>
            <span class="text-green-600 font-semibold" id="modalTraceStatus">æ£€æµ‹åˆ°æœ‰æ•ˆæ°´å°</span>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="flex items-start gap-2">
              <span class="text-gray-500 min-w-[120px]">æ¥æºä¸šåŠ¡ï¼š</span>
              <span class="font-medium text-gray-800" id="modalTraceSource">-</span>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-gray-500 min-w-[120px]">æ°´å°ç­–ç•¥ï¼š</span>
              <span class="font-medium text-gray-800" id="modalTraceStrategy">-</span>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-gray-500 min-w-[120px]">æ°´å°ç±»å‹ï¼š</span>
              <span class="font-medium text-gray-800" id="modalTraceWatermarkType">-</span>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-gray-500 min-w-[120px]">æ°´å°æ—¥æœŸï¼š</span>
              <span class="font-medium text-gray-800" id="modalTraceWatermarkDate">-</span>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-gray-500 min-w-[120px]">æ£€æµ‹æ—¶é—´ï¼š</span>
              <span class="font-medium text-gray-800" id="modalTraceTime">-</span>
            </div>
            <div class="flex items-start gap-2 sm:col-span-2">
              <span class="text-gray-500 min-w-[120px]">æ–‡ä»¶åç§°ï¼š</span>
              <span class="font-medium text-gray-800 break-words" id="modalTraceFileName">-</span>
            </div>
            <div class="flex items-start gap-2 sm:col-span-2">
              <span class="text-gray-500 min-w-[120px]">æ°´å°å†…å®¹ï¼š</span>
              <div class="flex-1">
                <div class="bg-gray-50 rounded-lg p-4 space-y-3 border border-gray-100">
                  <div class="flex items-center gap-2">
                    <span class="text-gray-500 text-sm min-w-[80px]">IPåœ°å€ï¼š</span>
                    <span class="font-medium text-gray-800 text-sm" id="modalTraceIP">-</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-gray-500 text-sm min-w-[80px]">ç”¨æˆ·åï¼š</span>
                    <span class="font-medium text-gray-800 text-sm" id="modalTraceUser">-</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-gray-500 text-sm min-w-[80px]">æ—¶é—´æˆ³ï¼š</span>
                    <span class="font-medium text-gray-800 text-sm" id="modalTraceTimestamp">-</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-gray-500 text-sm min-w-[80px]">æº¯æºæ ‡è¯†ï¼š</span>
                    <span class="font-medium text-gray-800 text-sm" id="modalTraceTraceId">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="p-4 border-t bg-white text-right">
          <button class="modal-close px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- Add Business Modal -->
    <div id="addBusinessModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg w-full max-w-3xl overflow-hidden max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex items-center justify-between">
          <div class="font-medium">æ–°å¢ä¸šåŠ¡</div>
          <button class="modal-close text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-4">
          <!-- Business Type Selection -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">ä¸šåŠ¡ç±»å‹</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="businessType" value="sdk" class="business-type-radio" checked />
                <span>SDKä¸šåŠ¡</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="businessType" value="jdbc" class="business-type-radio" />
                <span>JDBCä¸šåŠ¡</span>
              </label>
            </div>
          </div>
          <!-- SDK Form -->
          <div id="sdkBusinessForm" class="business-form">
            <form id="sdkForm" class="grid md:grid-cols-2 gap-4 text-sm">
              <label class="block md:col-span-2">
                <span class="text-gray-600">ä¸šåŠ¡åç§° <span class="text-red-500">*</span></span>
                <input required class="mt-1 w-full border rounded px-3 py-2" placeholder="å¦‚ï¼šCRMç³»ç»Ÿ" />
              </label>
              <label class="block">
                <span class="text-gray-600">è´Ÿè´£äºº</span>
                <input class="mt-1 w-full border rounded px-3 py-2" placeholder="å¦‚ï¼šå¼ ä¸‰" />
              </label>
              <label class="block">
                <span class="text-gray-600">æè¿°</span>
                <input class="mt-1 w-full border rounded px-3 py-2" placeholder="ä¸šåŠ¡æè¿°" />
              </label>
              <label class="block md:col-span-2">
                <span class="text-gray-600">å›è°ƒåœ°å€</span>
                <input class="mt-1 w-full border rounded px-3 py-2" placeholder="https://example.com/callback" />
              </label>
            </form>
          </div>
          <!-- JDBC Form -->
          <div id="jdbcBusinessForm" class="business-form hidden">
            <form id="jdbcForm" class="grid md:grid-cols-2 gap-4 text-sm">
              <label class="block md:col-span-2">
                <span class="text-gray-600">ä¸šåŠ¡åç§° <span class="text-red-500">*</span></span>
                <input required class="mt-1 w-full border rounded px-3 py-2" placeholder="å¦‚ï¼šæ•°æ®ä»“åº“" />
              </label>
              <label class="block">
                <span class="text-gray-600">æè¿°</span>
                <input class="mt-1 w-full border rounded px-3 py-2" placeholder="ä¸šåŠ¡æè¿°" />
              </label>
              <label class="block">
                <span class="text-gray-600">æ•°æ®åº“ç±»å‹</span>
                <select class="mt-1 w-full border rounded px-3 py-2">
                  <option>MySQL</option>
                  <option>PostgreSQL</option>
                  <option>SQL Server</option>
                </select>
              </label>
              <label class="block">
                <span class="text-gray-600">è¿æ¥ä¸²</span>
                <input class="mt-1 w-full border rounded px-3 py-2" placeholder="jdbc:mysql://host:3306/db" />
              </label>
              <label class="block">
                <span class="text-gray-600">è´¦å·</span>
                <input class="mt-1 w-full border rounded px-3 py-2" placeholder="ç”¨æˆ·å" />
              </label>
              <label class="block">
                <span class="text-gray-600">å¯†ç </span>
                <input type="password" class="mt-1 w-full border rounded px-3 py-2" placeholder="å¯†ç " />
              </label>
            </form>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end gap-2">
          <button class="modal-close px-4 py-2 rounded border hover:bg-gray-50">å–æ¶ˆ</button>
          <button class="px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- Add Strategy Modal -->
    <div id="addStrategyModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg w-full max-w-3xl overflow-hidden max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex items-center justify-between">
          <div class="font-medium">æ–°å¢æ°´å°ç­–ç•¥</div>
          <button class="modal-close text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-4">
          <form id="strategyForm" class="space-y-4 text-sm">
            <div class="grid grid-cols-2 gap-4">
              <label class="block">
                <span class="text-gray-600">ä¼˜å…ˆçº§ <span class="text-red-500">*</span></span>
                <input id="strategyPriority" required type="number" class="mt-1 w-full border rounded px-3 py-2" placeholder="1" />
              </label>
              <label class="block">
                <span class="text-gray-600">ç­–ç•¥åç§° <span class="text-red-500">*</span></span>
                <input id="strategyName" required class="mt-1 w-full border rounded px-3 py-2" placeholder="å¤–å‘æ–‡æ¡£æ°´å°" />
              </label>
            </div>
            <label class="block">
              <span class="text-gray-600">æè¿°</span>
              <input id="strategyDesc" class="mt-1 w-full border rounded px-3 py-2" placeholder="è¯´æ˜è¯¥ç­–ç•¥çš„åº”ç”¨åœºæ™¯" />
            </label>

            <div id="embedScopeArea">
              <label class="block">
                <span class="text-gray-600">åµŒå…¥èŒƒå›´</span>
                <select id="embedScopeSelect" class="mt-1 w-full border rounded px-3 py-2">
                  <option value="all">å…¨éƒ¨ä¸šåŠ¡</option>
                  <option value="specific">éƒ¨åˆ†ä¸šåŠ¡</option>
                </select>
              </label>
            </div>

            <div id="embedBizArea" class="hidden">
              <div class="grid grid-cols-2 gap-4 items-end">
                <label class="block">
                  <span class="text-gray-600">åµŒå…¥èŒƒå›´</span>
                  <select id="embedScopeSelectSpecific" class="mt-1 w-full border rounded px-3 py-2">
                    <option value="specific">éƒ¨åˆ†ä¸šåŠ¡</option>
                    <option value="all">å…¨éƒ¨ä¸šåŠ¡</option>
                  </select>
                </label>
                <label class="block">
                  <span class="text-gray-600">æ¥å…¥ä¸šåŠ¡</span>
                  <select id="embedBizSelect" class="mt-1 w-full border rounded px-3 py-2"></select>
                </label>
              </div>
              <div class="grid grid-cols-3 gap-4 items-end mt-4">
                <label class="block jdbc-only hidden">
                  <span class="text-gray-600">æ•°æ®æº</span>
                  <input id="jdbcDataSource" class="mt-1 w-full border rounded px-3 py-2" placeholder="æ•°æ®æºåç§°æˆ–è¿æ¥ä¸²" />
                </label>
                <label class="block jdbc-only hidden">
                  <span class="text-gray-600">æ•°æ®è´¦å·</span>
                  <input id="jdbcDataAccount" class="mt-1 w-fulborder rounded px-3 py-2" placeholder="è´¦å·ä¿¡æ¯" />
                </label>
              </div>
            </div>

            <div id="builtinRuleArea">
              <label class="block">
                <span class="text-gray-600">æ°´å°è§„åˆ™</span>
                <select id="watermarkRuleTypeSelect" class="mt-1 w-full border rounded px-3 py-2">
                <option value="builtin">å†…ç½®æ°´å°è§„åˆ™</option>
                <option value="template">æ¨¡ç‰ˆæ°´å°è§„åˆ™</option>
              </select>
              </label>
            </div>

            <div id="templateRuleArea" class="hidden">
              <div class="grid grid-cols-2 gap-4 items-end">
                <label class="block">
                  <span class="text-gray-600">æ°´å°è§„åˆ™</span>
                  <select id="strategyRuleSelectTemplate" class="mt-1 w-full border rounded px-3 py-2">
                    <!-- options populated by JS -->
                    <option value="template">æ¨¡ç‰ˆæ°´å°è§„åˆ™</option>
                    <option value="builtin">å†…ç½®æ°´å°è§„åˆ™</option>
                  </select>
                </label>
                <label class="block">
                  <span class="text-gray-600">è§„åˆ™æ¨¡ç‰ˆ</span>
                  <select id="strategyTemplateSelect" class="mt-1 w-full border rounded px-3 py-2">
                    <!-- options populated by JS -->
                  </select>
                </label>
              </div>
            </div>

          </form>
        </div>
        <div class="p-4 border-t flex justify-end gap-2">
          <button type="button" class="modal-close px-4 py-2 rounded border hover:bg-gray-50">å–æ¶ˆ</button>
          <button type="submit" form="strategyForm" class="px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700">ä¿å­˜ç­–ç•¥</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Watermark Rule Modal -->
    <div id="addWMRuleModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg w-full max-w-4xl overflow-hidden max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex items-center justify-between">
          <div class="font-medium" id="wmRuleModalTitle">æ–°å¢æ°´å°è§„åˆ™</div>
          <button class="modal-close text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-4">
          <form id="wmRuleForm" class="space-y-6 text-sm">
            <!-- Basic Information -->
            <fieldset>
              <legend class="font-medium text-lg">åŸºæœ¬ä¿¡æ¯</legend>
              <label class="block">
                <span class="text-gray-600">è§„åˆ™åç§° <span class="text-red-500">*</span></span>
                <input id="wmRuleName" required class="mt-1 w-full border rounded px-3 py-2" placeholder="å¦‚ï¼šæ–‡æ¡£å¤–å‘æ°´å°" />
              </label>
              <div class="grid grid-cols-2 gap-4 mt-4">
                <label class="block">
                  <span class="text-gray-600">æ°´å°ç®—æ³•</span>
                  <select id="wmAlgorithm" class="mt-1 w-full border rounded px-3 py-2">
                    <option value="frequency">é¢‘åŸŸå˜æ¢ç®—æ³•</option>
                    <option value="identifier">æ ‡è¯†æ°´å°ç®—æ³•</option>
                  </select>
                </label>
                <label class="block">
                  <span class="text-gray-600">æ°´å°è½½ä½“</span>
                  <select id="wmCarrier" class="mt-1 w-full border rounded px-3 py-2">
                    <option value="jpg">JPG</option>
                    <option value="png">PNG</option>
                    <option value="word">Word</option>
                    <option value="pdf">PDF</option>
                    <option value="ppt">PPT</option>
                    <option value="web">Web</option>
                    <option value="app">APP</option>
                  </select>
                </label>
              </div>
              <label class="block mt-4">
                <span class="text-gray-600">æè¿°</span>
                <textarea id="wmDescription" class="mt-1 w-full border rounded px-3 py-2" placeholder="æè¿°è¾“å…¥ï¼Œä¸è¶…è¿‡100å­—" maxlength="100"></textarea>
              </label>
            </fieldset>
              
            <div class="flex items-center gap-4 mt-4">
                <span class="text-gray-600">æ°´å°ç±»å‹</span>
                <label class="flex items-center gap-2"><input type="checkbox" id="wmTypeClear" /> æ˜æ°´å°</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="wmTypeSecret" /> æš—æ°´å°</label>
            </div>
            <!-- Watermark Settings -->
            <fieldset>
              <!-- Clear Watermark Settings -->
              <div id="clearWatermarkSettings" class="hidden">
                <div class="font-medium text-lg mb-4">æ˜æ°´å°è®¾ç½®</div>
                <div class="grid grid-cols-2 gap-6">
                  <!-- Left: Form Inputs -->
                  <div class="space-y-4">
                    <label class="block">
                      <span class="text-gray-600">æ°´å°å†…å®¹</span>
                      <input type="text" id="clearWatermarkContent" class="mt-1 w-full border rounded px-3 py-2" placeholder="è¯·è¾“å…¥æ°´å°æ–‡æœ¬" />
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                      <label class="block">
                        <span class="text-gray-600">å­—ä½“æ ·å¼</span>
                        <select id="clearFontFamily" class="mt-1 w-full border rounded px-3 py-2">
                          <option value="Arial">Arial</option>
                          <option value="Helvetica">Helvetica</option>
                          <option value="Times New Roman">Times New Roman</option>
                          <option value="Courier New">Courier New</option>
                          <option value="Verdana">Verdana</option>
                          <option value="Georgia">Georgia</option>
                        </select>
                      </label>
                      <label class="block">
                        <span class="text-gray-600">å­—ä½“å¤§å°</span>
                        <select id="clearFontSize" class="mt-1 w-full border rounded px-3 py-2">
                          <option value="12">12px</option>
                          <option value="14">14px</option>
                          <option value="16">16px</option>
                          <option value="18">18px</option>
                          <option value="20">20px</option>
                          <option value="24">24px</option>
                        </select>
                      </label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <label class="block">
                        <span class="text-gray-600">å­—ä½“æ ·å¼</span>
                        <select id="clearFontWeight" class="mt-1 w-full border rounded px-3 py-2">
                          <option value="normal">æ­£å¸¸</option>
                          <option value="bold">åŠ ç²—</option>
                          <option value="italic">å€¾æ–œ</option>
                        </select>
                      </label>
                      <label class="block">
                        <span class="text-gray-600">å­—ä½“é¢œè‰²</span>
                        <input type="color" id="clearFontColor" class="mt-1 w-full border rounded px-3 py-2 h-10" />
                      </label>
                    </div>
                    <label class="block">
                      <span class="text-gray-600">é€æ˜åº¦</span>
                      <div class="flex items-center gap-2 mt-1">
                        <input type="range" id="clearOpacity" class="flex-1" min="0" max="1" step="0.01" />
                        <span id="clearOpacityValue" class="text-sm text-gray-600 w-12">50%</span>
                      </div>
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                      <label class="block">
                        <span class="text-gray-600">æ’åˆ—æ–¹å¼</span>
                        <select id="clearArrangement" class="mt-1 w-full border rounded px-3 py-2">
                          <option value="tilt">å€¾æ–œ</option>
                          <option value="horizontal">æ°´å¹³</option>
                        </select>
                      </label>
                      <label class="block">
                        <span class="text-gray-600">è§’åº¦</span>
                        <input type="number" id="clearAngle" class="mt-1 w-full border rounded px-3 py-2" min="-45" max="45" value="0" />
                      </label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <label class="block">
                        <span class="text-gray-600">åˆ†å¸ƒä½ç½®</span>
                        <select id="clearPosition" class="mt-1 w-full border rounded px-3 py-2">
                          <option value="center">ç”»å¸ƒä¸­å¿ƒ</option>
                          <option value="bottom-left">å·¦ä¸‹è§’</option>
                          <option value="bottom-right">å³ä¸‹è§’</option>
                          <option value="top">é¡¶éƒ¨</option>
                          <option value="bottom">åº•éƒ¨</option>
                          <option value="right">å³ä¾§</option>
                          <option value="left">å·¦ä¾§</option>
                          <option value="top-left">å·¦ä¸Šè§’</option>
                          <option value="top-right">å³ä¸Šè§’</option>
                        </select>
                      </label>
                      <label class="block">
                        <span class="text-gray-600">æ°´å¹³é—´è·</span>
                        <input type="number" id="clearHorizontalSpacing" class="mt-1 w-full border rounded px-3 py-2" min="0" max="4096" value="0" />
                      </label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <label class="block">
                        <span class="text-gray-600">å‚ç›´é—´è·</span>
                        <input type="number" id="clearVerticalSpacing" class="mt-1 w-full border rounded px-3 py-2" min="0" max="4096" value="0" />
                      </label>
                      <label class="block">
                        <span class="text-gray-600">èƒŒæ™¯é¢œè‰²</span>
                        <input type="color" id="clearBgColor" class="mt-1 w-full border rounded px-3 py-2 h-10" />
                      </label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <label class="block">
                        <span class="text-gray-600">å›¾ç‰‡å®½åº¦</span>
                        <input type="number" id="clearImgWidth" class="mt-1 w-full border rounded px-3 py-2" min="1" />
                      </label>
                      <label class="block">
                        <span class="text-gray-600">å›¾ç‰‡é«˜åº¦</span>
                        <input type="number" id="clearImgHeight" class="mt-1 w-full border rounded px-3 py-2" min="1" />
                      </label>
                    </div>
                  </div>
                  <!-- Right: Preview -->
                  <div class="space-y-4">
                    <div class="font-medium">æ°´å°æ ·å¼é¢„è§ˆ</div>
                    <div class="border rounded-lg p-4 bg-gray-50 min-h-[300px] relative">
                      <div class="absolute top-2 left-2 text-md text-gray-600">é¢„è§ˆæ•ˆæœ</div>
                      <div id="watermarkPreview" class="w-full h-full relative">
                        <div id="previewText" class="absolute inline-block px-4 py-2 rounded" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
                          ç¤ºä¾‹æ°´å°æ–‡æœ¬
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            
              <!-- Secret Watermark Settings -->
              <div id="secretWatermarkSettings" class="hidden mt-6">
                <fieldset>
                  <legend class="font-medium text-lg mb-6">æš—æ°´å°è®¾ç½®</legend>
                  <div class="grid grid-cols-2 gap-4">
                    <label class="block">
                      <span class="text-gray-600">ç®—æ³•æ¨¡å¼</span>
                      <select id="secretAlgorithmMode" class="mt-1 w-full border rounded px-3 py-2">
                        <option value="dct">DCT</option>
                        <option value="dwt">DWT</option>
                      </select>
                    </label>
                  </div>
                </fieldset>
              </div>
            </fieldset>

            <div class="flex justify-end gap-2">
              <button type="button" class="modal-close px-4 py-2 rounded border hover:bg-gray-50">å–æ¶ˆ</button>
              <button type="submit" class="px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Strategy Form Template (hidden) -->
    <template id="strategyFormTpl">
      <form class="rounded border p-4 space-y-3 text-sm">
        <div class="grid grid-cols-2 gap-3">
          <label class="block">
            <span class="text-gray-600">ä¼˜å…ˆçº§</span>
            <input required type="number" class="mt-1 w-full border rounded px-3 py-2" placeholder="1" />
          </label>
          <label class="block">
            <span class="text-gray-600">ç­–ç•¥åç§°</span>
            <input required class="mt-1 w-full border rounded px-3 py-2" placeholder="å¤–å‘æ–‡æ¡£æ°´å°" />
          </label>
        </div>
        <label class="block">
          <span class="text-gray-600">æè¿°</span>
          <input class="mt-1 w-full border rounded px-3 py-2" placeholder="è¯´æ˜è¯¥ç­–ç•¥çš„åº”ç”¨åœºæ™¯" />
        </label>
        <div class="grid grid-cols-2 gap-3">
          <label class="block">
            <span class="text-gray-600">ç­–ç•¥èŒƒå›´</span>
            <select class="mt-1 w-full border rounded px-3 py-2">
              <option>æ–‡æœ¬</option>
              <option>å›¾ç‰‡</option>
              <option>æ–‡æ¡£</option>
              <option>æ•°æ®åº“ç»“æœé›†</option>
            </select>
          </label>
          <label class="block">
            <span class="text-gray-600">æ¥å…¥ä¸šåŠ¡</span>
            <select class="mt-1 w-full border rounded px-3 py-2">
              <option>CRMç³»ç»Ÿ</option>
              <option>ERPç³»ç»Ÿ</option>
              <option>æ•°æ®é—¨æˆ·</option>
            </select>
          </label>
        </div>
        <label class="block">
          <span class="text-gray-600">ç­–ç•¥è§„åˆ™</span>
          <input class="mt-1 w-full border rounded px-3 py-2" placeholder="å¦‚ï¼šé€æ˜åº¦ 20%ï¼Œæ–‡æ¡ˆå«ç”¨æˆ·åä¸æ—¶é—´" />
        </label>
        <div class="grid grid-cols-2 gap-3">
          <label class="block">
            <span class="text-gray-600">åˆ›å»ºæ—¶é—´</span>
            <input type="datetime-local" class="mt-1 w-full border rounded px-3 py-2" />
          </label>
          <div class="flex items-end justify-end gap-2">
            <button type="reset" class="px-3 py-2 rounded border">é‡ç½®</button>
            <button class="px-3 py-2 rounded bg-primary-600 text-white hover:bg-primary-700">ä¿å­˜ç­–ç•¥</button>
          </div>
        </div>
      </form>
    </template>

    <script>
      // Two-level router: module (top nav) + page (sidebar nav)
      const routeMap = {
        watermark: {
          home: 'view-home',
          strategy: 'view-strategy',
          trace: 'view-trace'
        },
        asset: {
          access: 'view-asset-access'
        },
        rules: {
          library: 'view-rules-library',
          'watermark-lib': 'view-rules-watermark-lib',
          templates: 'view-rules-templates'
        }
      };

      let currentModule = 'watermark';
      let currentPage = 'home';

      function setActiveModule(module) {
        currentModule = module;
        const sidebar = document.getElementById('sidebar');
        // Hide sidebar for rules module - force hide on all screen sizes
        if (module === 'rules') {
          sidebar.classList.add('hidden');
          sidebar.style.display = 'none'; // Force hide
        } else {
          sidebar.style.display = ''; // Reset display
          sidebar.classList.remove('hidden');
          // Update sidebar
          document.querySelectorAll('.sidebar-module').forEach(sb => sb.classList.add('hidden'));
          const activeSidebar = document.getElementById(`sidebar-${module}`);
          if (activeSidebar) activeSidebar.classList.remove('hidden');
        }
        // Reset to first page of module
        const firstPage = Object.keys(routeMap[module])[0];
        setActivePage(module, firstPage);
      }

      function setActivePage(module, page) {
        currentPage = page;
        // Hide all views
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        // Show target view
        const viewId = routeMap[module]?.[page];
        if (viewId) {
          const view = document.getElementById(viewId);
          if (view) view.classList.add('active');
        }
        // Update sidebar nav
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('bg-primary-50','text-primary-700','active');
          if (link.dataset.module === module && link.dataset.page === page) {
            link.classList.add('bg-primary-50','text-primary-700','active');
          }
        });
        // Update URL hash
        location.hash = `${module}/${page}`;
      }

      // åˆå§‹åŒ–è·¯ç”±
      function initRouter() {
        // ä» URL hash æ¢å¤è·¯ç”±çŠ¶æ€
        const hash = location.hash.slice(1); // ç§»é™¤ #
        if (hash) {
          const [module, page] = hash.split('/');
          if (module && routeMap[module]) {
            setActiveModule(module);
            if (page && routeMap[module][page]) {
              setActivePage(module, page);
            }
          }
        } else {
          // é»˜è®¤æ˜¾ç¤º watermark æ¨¡å—çš„ home é¡µé¢
          setActiveModule('watermark');
          setActivePage('watermark', 'home');
        }
      }

      function initWMRuleFormInteractions() {
        // ä¼˜å…ˆåœ¨å¼¹çª—å†…æŸ¥æ‰¾æ§ä»¶ï¼Œé¿å…ä¸é¡µé¢ä¸ŠåŒå id å†²çª
        const modal = document.getElementById('addWMRuleModal');
        const wmTypeClearCheckbox = modal.querySelector('#wmTypeClear');
        const wmTypeSecretCheckbox = modal.querySelector('#wmTypeSecret');
        const clearWatermarkPanel = modal.querySelector('#clearWatermarkSettings');
        const secretWatermarkPanel = modal.querySelector('#secretWatermarkSettings');

        if (wmTypeClearCheckbox && clearWatermarkPanel) {
          // initialize visibility correctly
          clearWatermarkPanel.classList.toggle('hidden', !wmTypeClearCheckbox.checked);
          wmTypeClearCheckbox.addEventListener('change', () => {
            clearWatermarkPanel.classList.toggle('hidden', !wmTypeClearCheckbox.checked);
          });
        }

        if (wmTypeSecretCheckbox && secretWatermarkPanel) {
          secretWatermarkPanel.classList.toggle('hidden', !wmTypeSecretCheckbox.checked);
          wmTypeSecretCheckbox.addEventListener('change', () => {
            secretWatermarkPanel.classList.toggle('hidden', !wmTypeSecretCheckbox.checked);
          });
        }

        // æ°´å°ç®—æ³•é€‰æ‹©æ§åˆ¶æš—æ°´å°ç®—æ³•æ¨¡å¼æ˜¾ç¤º
        const wmAlgSelect = modal.querySelector('#wmAlgorithm');
        const secretAlgMode = modal.querySelector('#secretAlgorithmMode');

        if (wmAlgSelect && secretAlgMode) {
          wmAlgSelect.addEventListener('change', () => {
            // only show secret algorithm mode when frequency algorithm is selected
            const show = wmAlgSelect.value === 'frequency';
            if (secretAlgMode.parentElement) secretAlgMode.parentElement.classList.toggle('hidden', !show);
          });
        }

        // Real-time preview updates
        const previewText = modal.querySelector('#previewText');
        const opacityValue = modal.querySelector('#clearOpacityValue');

        // Function to update preview
        function updatePreview() {
          if (!previewText) return;

          const content = modal.querySelector('#clearWatermarkContent')?.value || 'ç¤ºä¾‹æ°´å°æ–‡æœ¬';
          const fontFamily = modal.querySelector('#clearFontFamily')?.value || 'Arial';
          const fontSize = modal.querySelector('#clearFontSize')?.value || '16';
          const fontWeight = modal.querySelector('#clearFontWeight')?.value || 'normal';
          const fontColor = modal.querySelector('#clearFontColor')?.value || '#000000';
          const opacity = modal.querySelector('#clearOpacity')?.value || '0.5';
          const angle = modal.querySelector('#clearAngle')?.value || '0';
          const position = modal.querySelector('#clearPosition')?.value || 'center';
          const horizontalSpacing = parseInt(modal.querySelector('#clearHorizontalSpacing')?.value) || 0;
          const verticalSpacing = parseInt(modal.querySelector('#clearVerticalSpacing')?.value) || 0;

          previewText.textContent = content;
          previewText.style.fontFamily = fontFamily;
          previewText.style.fontSize = fontSize + 'px';
          previewText.style.fontWeight = fontWeight;
          previewText.style.color = fontColor;
          previewText.style.opacity = opacity;
          
          // Apply position styles
          previewText.style.position = 'absolute';
          previewText.style.transformOrigin = 'center';
          
          // Reset position styles
          previewText.style.marginLeft = '';
          previewText.style.marginTop = '';
          previewText.style.marginRight = '';
          previewText.style.marginBottom = '';
          previewText.style.alignSelf = '';
          previewText.parentElement.style.justifyContent = '';
          previewText.parentElement.style.alignItems = '';
          
          // è®¾ç½®é¢„è§ˆæ–‡æœ¬çš„ä¸­å¿ƒç‚¹
          previewText.style.left = '50%';
          previewText.style.top = '50%';
          
          // Apply position and spacing styles
          // æ‰€æœ‰ä½ç½®éƒ½ç›¸å¯¹äºä¸­å¿ƒç‚¹è¿›è¡Œå®šä½
          let translateX = 0;
          let translateY = 0;
          
          switch(position) {
            case 'center':
              // ä¿æŒåœ¨ä¸­å¿ƒä½ç½®
              translateX = 0;
              translateY = 0;
              break;
            case 'top-left':
              translateX = -horizontalSpacing;
              translateY = -verticalSpacing;
              break;
            case 'top-right':
              translateX = horizontalSpacing;
              translateY = -verticalSpacing;
              break;
            case 'bottom-left':
              translateX = -horizontalSpacing;
              translateY = verticalSpacing;
              break;
            case 'bottom-right':
              translateX = horizontalSpacing;
              translateY = verticalSpacing;
              break;
            case 'top':
              translateX = 0;
              translateY = -verticalSpacing;
              break;
            case 'bottom':
              translateX = 0;
              translateY = verticalSpacing;
              break;
            case 'left':
              translateX = -horizontalSpacing;
              translateY = 0;
              break;
            case 'right':
              translateX = horizontalSpacing;
              translateY = 0;
              break;
          }
          
          // Apply rotation and position
          // ç¡®ä¿å§‹ç»ˆç›¸å¯¹äºç”»å¸ƒä¸­å¿ƒå®šä½
          previewText.style.transform = `translate(-50%, -50%) translate(${translateX}px, ${translateY}px) rotate(${angle}deg)`;

          // Update percentage display
          if (opacityValue) {
            opacityValue.textContent = Math.round(parseFloat(opacity) * 100) + '%';
          }
        }
        
        // åˆå§‹åŒ–æ—¶ç¡®ä¿é¢„è§ˆæ–‡æœ¬åœ¨ä¸­å¿ƒ
        if (previewText) {
          previewText.style.left = '50%';
          previewText.style.top = '50%';
          previewText.style.transform = 'translate(-50%, -50%)';
        }

        // Function to adjust spacing based on position selection
        function adjustSpacingByPosition() {
          const positionSelect = modal.querySelector('#clearPosition');
          const horizontalSpacingInput = modal.querySelector('#clearHorizontalSpacing');
          const verticalSpacingInput = modal.querySelector('#clearVerticalSpacing');
          
          if (!positionSelect || !horizontalSpacingInput || !verticalSpacingInput) return;
          
          // Set recommended spacing values based on position
          // æ‰€æœ‰ä½ç½®ç›¸å¯¹äºä¸­å¿ƒç‚¹è¿›è¡Œè®¾ç½®
          switch(positionSelect.value) {
            case 'center':
              horizontalSpacingInput.value = '0';
              verticalSpacingInput.value = '0';
              break;
            case 'top-left':
              horizontalSpacingInput.value = '100';
              verticalSpacingInput.value = '100';
              break;
            case 'top-right':
              horizontalSpacingInput.value = '100';
              verticalSpacingInput.value = '100';
              break;
            case 'bottom-left':
              horizontalSpacingInput.value = '100';
              verticalSpacingInput.value = '100';
              break;
            case 'bottom-right':
              horizontalSpacingInput.value = '100';
              verticalSpacingInput.value = '100';
              break;
            case 'top':
              horizontalSpacingInput.value = '0';
              verticalSpacingInput.value = '100';
              break;
            case 'bottom':
              horizontalSpacingInput.value = '0';
              verticalSpacingInput.value = '100';
              break;
            case 'left':
              horizontalSpacingInput.value = '100';
              verticalSpacingInput.value = '0';
              break;
            case 'right':
              horizontalSpacingInput.value = '100';
              verticalSpacingInput.value = '0';
              break;
            default:
              horizontalSpacingInput.value = '0';
              verticalSpacingInput.value = '0';
          }
          
          // Update preview with new spacing values
          updatePreview();
        }

        // Bind events to form inputs for real-time preview
        const inputs = [
          '#clearWatermarkContent',
          '#clearFontFamily',
          '#clearFontSize',
          '#clearFontWeight',
          '#clearFontColor',
          '#clearOpacity',
          '#clearAngle',
          '#clearHorizontalSpacing',
          '#clearVerticalSpacing'
        ];

        inputs.forEach(selector => {
          const el = modal.querySelector(selector);
          if (el) {
            el.addEventListener('input', updatePreview);
            el.addEventListener('change', updatePreview);
          }
        });

        // Bind special event to position select to adjust spacing
        const positionSelect = modal.querySelector('#clearPosition');
        if (positionSelect) {
          positionSelect.addEventListener('change', function() {
            adjustSpacingByPosition();
            updatePreview();
          });
        }

        // Initial preview update
        updatePreview();
      }
      function bindModal(triggerId, modalId) {
        const trigger = document.getElementById(triggerId);
        const modal = document.getElementById(modalId);
        if (!trigger || !modal) return;
        const closeEls = modal.querySelectorAll('.modal-close');
        trigger.addEventListener('click', () => {
          // If opening the Add Strategy modal, ensure form is reset and prepared
          try { if (modalId === 'addStrategyModal' && typeof prepareStrategyModal === 'function') prepareStrategyModal(); } catch(e) {}
          modal.classList.remove('hidden');
        });
        closeEls.forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
      }
      bindModal('btnStrategyGuide', 'strategyGuideModal');
      bindModal('btnAssetGuide', 'assetGuideModal');
      bindModal('btnAddBusiness', 'addBusinessModal');
      bindModal('btnAddStrategy', 'addStrategyModal');
      bindModal('btnAddWMRule', 'addWMRuleModal');

      // Add Business Modal - Business Type Toggle
      const businessTypeRadios = document.querySelectorAll('.business-type-radio');
      const sdkBusinessForm = document.getElementById('sdkBusinessForm');
      const jdbcBusinessForm = document.getElementById('jdbcBusinessForm');
      businessTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.value === 'sdk') {
            sdkBusinessForm.classList.remove('hidden');
            jdbcBusinessForm.classList.add('hidden');
          } else {
            sdkBusinessForm.classList.add('hidden');
            jdbcBusinessForm.classList.remove('hidden');
          }
        });
      });

      // Strategy: add form and list handling
  const strategyListEl = document.getElementById('strategyList');
  const btnAddStrategy = document.getElementById('btnAddStrategy');
      // ç­–ç•¥æ•°æ®æŒ‰ç±»å‹åˆ†ç»„
      const strategies = {
        sdk: [
          { priority: '1', name: 'ç­–ç•¥A - å¯¹å¤–å…±äº«æŠ¥è¡¨', desc: 'å¯¹å¤–æŠ¥è¡¨å¯¼å‡ºæ—¶æ·»åŠ åŠé€æ˜æ–‡æ¡£æ°´å°', scope: 'æ–‡æ¡£', biz: 'æ•°æ®é—¨æˆ·', rule: 'å¯¹å¤–å…±äº«æŠ¥è¡¨', created: '2025-11-10 10:00' }
        ],
        jdbc: [
          { priority: '2', name: 'ç­–ç•¥B - å›¾ç‰‡å¤–å‘ä¿æŠ¤', desc: 'å¤–å‘å›¾ç‰‡æ·»åŠ å¼ºæ°´å°å¹¶æ ‡æ³¨è´£ä»»äºº', scope: 'å›¾ç‰‡', biz: 'CRMç³»ç»Ÿ', rule: 'å›¾ç‰‡å¤–å‘', created: '2025-11-10 11:00' }
        ]
      };
      let currentStrategyTab = 'sdk';

      function renderStrategyRow(item, idx, tbody) {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${item.priority || '-'}</td>
          <td class="px-3 py-2 text-sm font-medium">${item.name || '-'}</td>
          <td class="px-3 py-2 text-sm">${item.scope || item.embedScope || '-'}</td>
          <td class="px-3 py-2 text-sm">${item.biz || '-'}</td>
          <td class="px-3 py-2 text-sm">${item.rule || item.template || '-'}</td>
          <td class="px-3 py-2 text-sm text-gray-500">${item.created || '-'}</td>
          <td class="px-3 py-2 text-sm">
            <button class="text-primary-600 hover:underline" data-action="edit" data-idx="${idx}">ç¼–è¾‘</button>
            <span class="mx-2 text-gray-300">|</span>
            <button class="text-red-600 hover:underline" data-action="del" data-idx="${idx}">åˆ é™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      function refreshStrategyTable() {
        if (!strategyListEl) return;
        // Render as a simple table with columns: ä¼˜å…ˆçº§, åç§°, èŒƒå›´, ä¸šåŠ¡, è§„åˆ™, åˆ›å»ºæ—¶é—´, æ“ä½œ
        strategyListEl.innerHTML = `
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead>
                <tr class="text-xs text-gray-600 border-b">
                  <th class="px-3 py-2">ä¼˜å…ˆçº§</th>
                  <th class="px-3 py-2">åç§°</th>
                  <th class="px-3 py-2">èŒƒå›´</th>
                  <th class="px-3 py-2">ä¸šåŠ¡</th>
                  <th class="px-3 py-2">è§„åˆ™</th>
                  <th class="px-3 py-2">åˆ›å»ºæ—¶é—´</th>
                  <th class="px-3 py-2">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="strategyTableBody"></tbody>
            </table>
          </div>
        `;
        const tbody = document.getElementById('strategyTableBody');
        (strategies[currentStrategyTab] || []).forEach((s, i) => renderStrategyRow(s, i, tbody));
      }

      // Strategy form submit handler
      const strategyForm = document.getElementById('strategyForm');
      const addStrategyModal = document.getElementById('addStrategyModal');
      if (strategyForm) {
        strategyForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const priority = document.getElementById('strategyPriority').value;
          const name = document.getElementById('strategyName').value;
          const desc = document.getElementById('strategyDesc').value;
          const watermarkType = (document.querySelector('input[name="watermarkType"]:checked') || {}).value || 'clear';
          const embedScope = document.getElementById('embedScopeSelect').value;
          const biz = embedScope === 'specific' ? document.getElementById('embedBizSelect').value : 'å…¨éƒ¨ä¸šåŠ¡';
          const jdbcDataSource = document.getElementById('jdbcDataSource') ? document.getElementById('jdbcDataSource').value : '';
          const jdbcDataAccount = document.getElementById('jdbcDataAccount') ? document.getElementById('jdbcDataAccount').value : '';
          const templateKind = (document.querySelector('input[name="strategyTemplateKind"]:checked') || {}).value || 'builtin';
          const template = document.getElementById('strategyTemplateSelect').value;
          const watermarkRuleType = document.getElementById('watermarkRuleTypeSelect').value || 'builtin';
          const rule = watermarkRuleType === 'builtin' ? document.getElementById('strategyRuleSelect').value : document.getElementById('strategyRuleSelectTemplate').value;
          const created = document.getElementById('strategyCreated').value || new Date().toLocaleString();
          const record = { priority, name, desc, watermarkType, embedScope, biz, jdbcDataSource, jdbcDataAccount, templateKind, template, watermarkRuleType, rule, created };
          strategies[currentStrategyTab].push(record);
          refreshStrategyTable();
          strategyForm.reset();
          addStrategyModal.classList.add('hidden');
        });
      }

      if (strategyListEl) {
        strategyListEl.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const idx = Number(btn.dataset.idx);
          const action = btn.dataset.action;
          if (action === 'del') {
            strategies[currentStrategyTab].splice(idx, 1);
            refreshStrategyTable();
          }
        });
      }
      // ç­–ç•¥é¡µç­¾åˆ‡æ¢é€»è¾‘
      const strategyTabs = document.getElementById('strategyTabs');
      if (strategyTabs) {
        strategyTabs.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-tab]');
          if (!btn) return;
          strategyTabs.querySelectorAll('button').forEach(b => b.classList.remove('bg-primary-50','text-primary-700','border-b-2','border-primary-600'));
          btn.classList.add('bg-primary-50','text-primary-700','border-b-2','border-primary-600');
          currentStrategyTab = btn.dataset.tab;
          refreshStrategyTable();
          // reset modal fields when switching tabs to avoid cross-tab residue
          try { prepareStrategyModal(); } catch (e) {}
        });
      }
      // åˆå§‹åŒ–ç­–ç•¥åˆ—è¡¨
      refreshStrategyTable();

      // Prepare strategy modal fields depending on current tab (SDK/JDBC)
      function prepareStrategyModal() {
        // æ‰“å¼€æ–°å¢ç­–ç•¥æ—¶é‡ç½®è¡¨å•å‚æ•°
        const strategyForm = document.getElementById('strategyForm');
        if (strategyForm) strategyForm.reset();
        const embedBizArea = document.getElementById('embedBizArea');
        const embedScopeArea = document.getElementById('embedScopeArea');
        const embedScopeSelect = document.getElementById('embedScopeSelect');
        const embedBizSelect = document.getElementById('embedBizSelect');
        const jdbcDataSourceWraps = document.querySelectorAll('.jdbc-only');
        // populate business select
        if (embedBizSelect) {
          embedBizSelect.innerHTML = assetData.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
        }
        // show/hide based on selection
        if (embedScopeSelect) {
          // default to 'all' and hide dependent areas to avoid retaining previous selections
          embedScopeSelect.value = 'all';
          embedBizArea && embedBizArea.classList.add('hidden');
          embedScopeArea && embedScopeArea.classList.remove('hidden');
          jdbcDataSourceWraps.forEach(w => w.classList.add('hidden'));
          
          embedScopeSelect.onchange = () => {
            if (embedScopeSelect.value === 'specific') {
              // å½“é€‰æ‹©"éƒ¨åˆ†ä¸šåŠ¡"æ—¶ï¼Œéšè—åŸå§‹çš„åµŒå…¥èŒƒå›´ä¸‹æ‹‰æ¡†ï¼Œæ˜¾ç¤ºåŒ…å«ä¸¤ä¸ªä¸‹æ‹‰æ¡†çš„åŒºåŸŸ
              embedScopeArea && embedScopeArea.classList.add('hidden');
              embedBizArea && embedBizArea.classList.remove('hidden');
              // show jdbc-specific inputs only for JDBC tab
              jdbcDataSourceWraps.forEach(w => {
                if (currentStrategyTab === 'jdbc') w.classList.remove('hidden'); else w.classList.add('hidden');
              });
            } else {
              // å½“é€‰æ‹©"å…¨éƒ¨ä¸šåŠ¡"æ—¶ï¼Œæ˜¾ç¤ºåŸå§‹çš„åµŒå…¥èŒƒå›´ä¸‹æ‹‰æ¡†ï¼Œéšè—éƒ¨åˆ†ä¸šåŠ¡åŒºåŸŸ
              embedScopeArea && embedScopeArea.classList.remove('hidden');
              embedBizArea && embedBizArea.classList.add('hidden');
              jdbcDataSourceWraps.forEach(w => w.classList.add('hidden'));
            }
          };
          
          // å¤„ç†éƒ¨åˆ†ä¸šåŠ¡åŒºåŸŸå†…é€‰æ‹©"å…¨éƒ¨ä¸šåŠ¡"çš„æƒ…å†µ
          const embedScopeSelectSpecific = document.getElementById('embedScopeSelectSpecific');
          if (embedScopeSelectSpecific) {
            embedScopeSelectSpecific.onchange = () => {
              if (embedScopeSelectSpecific.value === 'all') {
                // å½“åœ¨éƒ¨åˆ†ä¸šåŠ¡åŒºåŸŸé€‰æ‹©"å…¨éƒ¨ä¸šåŠ¡"æ—¶ï¼Œæ˜¾ç¤ºåŸå§‹çš„åµŒå…¥èŒƒå›´ä¸‹æ‹‰æ¡†ï¼Œéšè—éƒ¨åˆ†ä¸šåŠ¡åŒºåŸŸ
                embedScopeArea && embedScopeArea.classList.remove('hidden');
                embedBizArea && embedBizArea.classList.add('hidden');
                jdbcDataSourceWraps.forEach(w => w.classList.add('hidden'));
                
                // åŒæ­¥ä¸»ä¸‹æ‹‰æ¡†çš„å€¼
                if (embedScopeSelect) {
                  embedScopeSelect.value = 'all';
                  // è§¦å‘ä¸»ä¸‹æ‹‰æ¡†çš„changeäº‹ä»¶ä»¥ç¡®ä¿UIçŠ¶æ€ä¸€è‡´
                  embedScopeSelect.dispatchEvent(new Event('change'));
                }
              }
            };
          }
          
          // ensure onchange applied to reflect initial state
          try { embedScopeSelect.onchange(); } catch (e) {}
        }

        // Populate default template select
        populateStrategyTemplateSelect('builtin');
        // Populate rule selects
        populateStrategyRuleSelect();
      }

      // When clicking æ–°å¢ç­–ç•¥, prepare modal with context
      const btnAddStrategyEl = document.getElementById('btnAddStrategy');
      if (btnAddStrategyEl) {
        btnAddStrategyEl.addEventListener('click', () => {
          // prepare fields
          prepareStrategyModal();
          // show modal handled by existing bindModal
        });
      }

      // Trace upload + history
      const traceInput = document.getElementById('traceFile');
      const traceFileBrowse = document.getElementById('traceFileBrowse');
      const traceFileName = document.getElementById('traceFileName');
      const traceResult = document.getElementById('traceResult');
      const traceResultEmpty = document.getElementById('traceResultEmpty');
      const traceResultData = document.getElementById('traceResultData');
      const traceHistory = document.getElementById('traceHistory');
      
      // å­˜å‚¨æº¯æºè®°å½•æ•°æ®
      const traceRecords = [];
      
      // æ–‡ä»¶é€‰æ‹©æµè§ˆæ¡†ç‚¹å‡»äº‹ä»¶
      traceFileBrowse.addEventListener('click', () => traceInput.click());
      traceInput.addEventListener('change', () => {
        traceFileName.textContent = traceInput.files[0] ? traceInput.files[0].name : 'è¯·é€‰æ‹©æ–‡ä»¶';
      });
      
      // æ˜¾ç¤ºæº¯æºç»“æœçš„å‡½æ•°ï¼ˆç”¨äºé¡µé¢æ˜¾ç¤ºï¼‰
      const displayTraceResult = (data) => {
        if (!data) {
          traceResultEmpty.classList.remove('hidden');
          traceResultData.classList.add('hidden');
          return;
        }
        
        traceResultEmpty.classList.add('hidden');
        traceResultData.classList.remove('hidden');
        
        const updateField = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value || '-';
        };
        
        updateField('traceResultStatus', data.status || 'æ£€æµ‹åˆ°æœ‰æ•ˆæ°´å°');
        updateField('traceResultSource', data.sourceBusiness);
        updateField('traceResultStrategy', data.strategy);
        updateField('traceResultWatermarkType', data.watermarkType);
        updateField('traceResultWatermarkDate', data.watermarkDate);
        updateField('traceResultFileName', data.fileName);
        updateField('traceResultIP', data.ip);
        updateField('traceResultUser', data.user);
        updateField('traceResultTimestamp', data.timestamp);
        updateField('traceResultTraceId', data.traceId);
      };
      
      // æ˜¾ç¤ºæº¯æºè¯¦æƒ…æ¨¡æ€æ¡†çš„å‡½æ•°
      const displayTraceDetailModal = (data) => {
        if (!data) return;
        
        const updateField = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value || '-';
        };
        
        updateField('modalTraceStatus', data.status || 'æ£€æµ‹åˆ°æœ‰æ•ˆæ°´å°');
        updateField('modalTraceSource', data.sourceBusiness);
        updateField('modalTraceStrategy', data.strategy);
        updateField('modalTraceWatermarkType', data.watermarkType);
        updateField('modalTraceWatermarkDate', data.watermarkDate);
        updateField('modalTraceTime', data.time);
        updateField('modalTraceFileName', data.fileName);
        updateField('modalTraceIP', data.ip);
        updateField('modalTraceUser', data.user);
        updateField('modalTraceTimestamp', data.timestamp);
        updateField('modalTraceTraceId', data.traceId);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = document.getElementById('traceDetailModal');
        if (modal) {
          modal.classList.remove('hidden');
        }
      };
      
      btnDoTrace.addEventListener('click', () => {
        if (!traceInput.files[0]) { alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶'); return; }
        
        // å¡«å……æº¯æºç»“æœä¿¡æ¯
        const now = new Date();
        const nowStr = now.toLocaleString('zh-CN', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit' 
        });
        const fileName = traceInput.files[0].name;
        const sourceBusiness = 'CRMç³»ç»Ÿ';
        const strategy = 'å¤–å‘æ–‡æ¡£æ°´å°';
        
        // ç”Ÿæˆæ°´å°ç›¸å…³ä¿¡æ¯ï¼ˆç¤ºä¾‹æ•°æ®ï¼‰
        const watermarkTypes = [
          { visibility: 'æ˜æ°´å°', category: 'æ–‡ä»¶æ°´å°' },
          { visibility: 'æš—æ°´å°', category: 'å›¾ç‰‡æ°´å°' },
          { visibility: 'æ˜æ°´å°', category: 'æ•°æ®æ°´å°' }
        ];
        const randomType = watermarkTypes[Math.floor(Math.random() * watermarkTypes.length)];
        const watermarkType = `${randomType.visibility} / ${randomType.category}`;
        
        // ç”Ÿæˆæ°´å°æ—¥æœŸï¼ˆå‡è®¾æ˜¯3å¤©å‰ï¼‰
        const watermarkDate = new Date(now);
        watermarkDate.setDate(watermarkDate.getDate() - 3);
        const watermarkDateStr = watermarkDate.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        // ç”Ÿæˆæ°´å°å†…å®¹
        const generateIP = () => {
          return `${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
        };
        const users = ['admin', 'zhangsan', 'lisi', 'wangwu', 'zhaoliu'];
        const randomUser = users[Math.floor(Math.random() * users.length)];
        const traceId = `TRACE-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(Math.floor(Math.random() * 999) + 1).padStart(3, '0')}`;
        
        // æ„å»ºå®Œæ•´çš„æº¯æºæ•°æ®å¯¹è±¡
        const traceData = {
          id: Date.now(),
          time: nowStr,
          fileName: fileName,
          status: 'æœ‰æ•ˆæ°´å°',
          sourceBusiness: sourceBusiness,
          strategy: strategy,
          watermarkType: watermarkType,
          watermarkDate: watermarkDateStr,
          ip: generateIP(),
          user: randomUser,
          timestamp: watermarkDateStr,
          traceId: traceId
        };
        
        // ä¿å­˜åˆ°è®°å½•æ•°ç»„
        traceRecords.unshift(traceData);
        
        // æ˜¾ç¤ºæº¯æºç»“æœ
        displayTraceResult(traceData);
        
        // æ·»åŠ åˆ°æº¯æºè®°å½•è¡¨
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4">${nowStr}</td>
          <td class="py-2 pr-4">${fileName}</td>
          <td class="py-2 pr-4 text-green-600">æœ‰æ•ˆæ°´å°</td>
          <td class="py-2 pr-4">${sourceBusiness}</td>
          <td class="py-2 pr-4">${strategy}</td>
          <td class="py-2 pr-4">
            <button class="text-primary-600 hover:text-primary-700 view-trace-btn" data-id="${traceData.id}">
              <i class="fa-solid fa-eye mr-1"></i>æŸ¥çœ‹
            </button>
          </td>`;
        traceHistory.prepend(tr);
        
        // ç»‘å®šæŸ¥çœ‹æŒ‰é’®äº‹ä»¶
        const viewBtn = tr.querySelector('.view-trace-btn');
        viewBtn.addEventListener('click', () => {
          displayTraceDetailModal(traceData);
        });
      });
      
      // ä¸ºå·²å­˜åœ¨çš„æŸ¥çœ‹æŒ‰é’®ç»‘å®šäº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
      traceHistory.addEventListener('click', (e) => {
        if (e.target.closest('.view-trace-btn')) {
          const btn = e.target.closest('.view-trace-btn');
          const id = parseInt(btn.getAttribute('data-id'));
          const record = traceRecords.find(r => r.id === id);
          if (record) {
            displayTraceDetailModal(record);
          }
        }
      });
      
      // ç»‘å®šæ¨¡æ€æ¡†å…³é—­äº‹ä»¶
      const traceDetailModal = document.getElementById('traceDetailModal');
      if (traceDetailModal) {
        const closeEls = traceDetailModal.querySelectorAll('.modal-close');
        closeEls.forEach(btn => {
          btn.addEventListener('click', () => traceDetailModal.classList.add('hidden'));
        });
        traceDetailModal.addEventListener('click', (e) => {
          if (e.target === traceDetailModal) {
            traceDetailModal.classList.add('hidden');
          }
        });
      }

      // Assets list demo data
      const assetTable = document.getElementById('assetTable');
      const assetData = [
        { name: 'ç”¨æˆ·ä¸­å¿ƒ', desc: 'ç”¨æˆ·ç›¸å…³ä¸šåŠ¡', status: 'å·²æ¥å…¥', statusColor: 'green' },
        { name: 'è®¢å•ç³»ç»Ÿ', desc: 'è®¢å•ç›¸å…³ä¸šåŠ¡', status: 'æœªæ¥å…¥', statusColor: 'red' }
      ];
      function renderAssetTable() {
        assetTable.innerHTML = '';
        assetData.forEach((a, idx) => {
          const tr = document.createElement('tr');
          const statusClass = a.statusColor === 'green' ? 'text-green-600' : 'text-red-600';
          tr.innerHTML = `
            <td class="py-2 pr-4">${a.name}</td>
            <td class="py-2 pr-4">${a.desc}</td>
            <td class="py-2 pr-4 ${statusClass}">${a.status}</td>
            <td class="py-2 pr-4">
              <button class="text-gray-500 hover:text-gray-700" title="æŸ¥çœ‹å‡­è¯">
                <i class="fa-solid fa-eye"></i>
              </button>
            </td>
            <td class="py-2 pr-4">
              <button class="text-primary-600 hover:text-primary-700 mr-2" title="ç¼–è¾‘">
                <i class="fa-solid fa-pen"></i>
              </button>
              <button class="text-red-600 hover:text-red-700" title="åˆ é™¤">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>`;
          assetTable.appendChild(tr);
        });
      }
      renderAssetTable();

      // Rules library tabs demo
      const rulesTabs = document.getElementById('rulesTabs');
      const rulesTabContent = document.getElementById('rulesTabContent');
      const templatesContent = document.getElementById('rules-templates-content');
      
      // Watermark rules list demo - define wmRules first
      const wmRulesBody = document.getElementById('wmRulesBody');
      const wmRules = [
        { id: 'WM-001', name: 'æ–‡æ¡£å¤–å‘å¼ºæ°´å°', type: 'æ–‡æ¡£', opacity: '20', /*content: 'ç”¨æˆ·å+æ—¶é—´',*/ source: 'built-in', waterAlg: 'ç®—æ³•A', encAlg: 'RSA', updated: '2025-10-12 12:01' },
        { id: 'WM-018', name: 'å›¾ç‰‡æ°´å°ï¼ˆåŠé€æ˜ï¼‰', type: 'å›¾ç‰‡', opacity: '30', tilt: '0', /*content: 'ä¸šåŠ¡æ ‡è¯†',*/ source: 'custom', waterAlg: 'ç®—æ³•B', encAlg: 'AES', updated: '2025-10-22 09:15' }
      ];
      
      function renderWMRules() {
        if (wmRulesBody) {
          wmRulesBody.innerHTML = '';
          wmRules.forEach((r, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="py-2 pr-4">${r.id}</td>
              <td class="py-2 pr-4">${r.name}</td>
              <td class="py-2 pr-4">${r.type}</td>
              <td class="py-2 pr-4">${r.waterAlg || ''}</td>
              <td class="py-2 pr-4">${r.encAlg || ''}</td>
              <td class="py-2 pr-4">${r.source === 'built-in' ? 'å†…ç½®' : 'è‡ªå®šä¹‰'}</td>
              <td class="py-2 pr-4">${r.updated}</td>
              <td class="py-2 pr-4">
                <button class="edit-wm-rule text-primary-600 hover:underline mr-2" data-idx="${idx}">ç¼–è¾‘</button>
                <button class="delete-wm-rule text-red-600 hover:underline" data-idx="${idx}">åˆ é™¤</button>
              </td>`;
            wmRulesBody.appendChild(tr);
          });
        }
      }
      renderWMRules();
      // Populate template rule select (in addTemplateModal) from watermark rules
      function populateTemplateRuleSelect() {
        const sel = document.getElementById('templateRuleSelect');
        if (!sel) return;
        // åˆ—å‡ºæ‰€æœ‰æ°´å°è§„åˆ™ï¼ˆåŒºåˆ†æ¥æºï¼‰
        sel.innerHTML = wmRules.map(r => `<option value="${r.name}">${r.id} Â· ${r.name} Â· ${r.source === 'built-in' ? 'å†…ç½®' : 'è‡ªå®šä¹‰'}</option>`).join('');
      }
      populateTemplateRuleSelect();

      // å¡«å……ç­–ç•¥æ¨¡ç‰ˆä¸‹æ‹‰ï¼ˆæŒ‰æ¨¡ç‰ˆæ¥æºè¿‡æ»¤ï¼‰
      function populateStrategyTemplateSelect(kind) {
        const sel = document.getElementById('strategyTemplateSelect');
        if (!sel) return;
        const list = templates.filter(t => (kind === 'builtin') ? (t.source === 'built-in') : (t.source === 'custom'));
        sel.innerHTML = list.map(t => `<option value="${t.name}">${t.id} Â· ${t.name}</option>`).join('');
      }
      
      // Watermark rules tab content generator
      function generateWatermarkRulesTabContent() {
        const rulesHtml = wmRules.map((r, idx) => `
          <tr>
            <td class="py-2 pr-4">${r.id}</td>
            <td class="py-2 pr-4">${r.name}</td>
            <td class="py-2 pr-4">${r.type}</td>
            <td class="py-2 pr-4">${r.waterAlg || ''}</td>
            <td class="py-2 pr-4">${r.encAlg || ''}</td>
            <td class="py-2 pr-4">${r.updated}</td>
            <td class="py-2 pr-4">
              <button class="edit-wm-rule text-primary-600 hover:underline mr-2" data-idx="${idx}">ç¼–è¾‘</button>
              <button class="delete-wm-rule text-red-600 hover:underline" data-idx="${idx}">åˆ é™¤</button>
            </td>
          </tr>
        `).join('');
        return `
          <div>
            <div class="flex items-center justify-end mb-4">
              <button id="btnAddWMRuleInTab" class="px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700 text-sm">
                <i class="fa-solid fa-plus mr-2"></i>æ–°å¢è§„åˆ™
              </button>
            </div>
            <div class="bg-white rounded-lg shadow-sm border overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-gray-500 border-b">
                    <th class="py-2 pr-4">è§„åˆ™ID</th>
                    <th class="py-2 pr-4">è§„åˆ™åç§°</th>
                    <th class="py-2 pr-4">ç±»å‹</th>
                    <th class="py-2 pr-4">æ°´å°ç®—æ³•</th>
                    <th class="py-2 pr-4">åŠ å¯†ç®—æ³•</th>
                    <th class="py-2 pr-4">æ›´æ–°æ—¶é—´</th>
                    <th class="py-2 pr-4">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>${rulesHtml || '<tr><td colspan="7" class="py-4 text-center text-gray-400">æš‚æ— è§„åˆ™</td></tr>'}</tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      const tabContents = {
        'rules-audit': `<div class="overflow-x-auto"><table class="min-w-full text-sm"><thead><tr class="text-left text-gray-500"><th class="py-2 pr-4">è§„åˆ™å</th><th class="py-2 pr-4">ç±»å‹</th><th class="py-2 pr-4">çº§åˆ«</th></tr></thead><tbody><tr><td class="py-2 pr-4">èº«ä»½è¯è¯†åˆ«</td><td class="py-2 pr-4">è¯†åˆ«</td><td class="py-2 pr-4">é«˜</td></tr><tr><td class="py-2 pr-4">æ‰‹æœºå·è„±æ•</td><td class="py-2 pr-4">è„±æ•</td><td class="py-2 pr-4">ä¸­</td></tr></tbody></table></div>`,
        'rules-watermark': generateWatermarkRulesTabContent(),
        'rules-templates': templatesContent ? templatesContent.outerHTML : '',
        'rules-dict': `<div>ç‰¹å¾å­—å…¸æ ·ä¾‹ï¼š<span class="px-2 py-1 bg-gray-100 rounded">å§“å</span>ã€<span class="px-2 py-1 bg-gray-100 rounded">æ‰‹æœºå·</span>ã€<span class="px-2 py-1 bg-gray-100 rounded">é“¶è¡Œå¡</span></div>`,
        'rules-canvas': `<div class="text-gray-700">åœ¨ç®—å­ç”»å¸ƒä¸­æ‹–æ‹½"è¾“å…¥ â†’ è§„åˆ™ â†’ è¾“å‡º"ä»¥ç»„åˆæ•°æ®å¤„ç†æµç¨‹ï¼ˆåŸå‹å ä½ï¼‰ã€‚</div>`
      };
      
      if (rulesTabs && rulesTabContent) {
        rulesTabs.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-tab]');
          if (!btn) return;
          // Update tab buttons
          rulesTabs.querySelectorAll('button').forEach(b => {
            b.classList.remove('bg-primary-50','text-primary-700','border-b-2','border-primary-600');
          });
          btn.classList.add('bg-primary-50','text-primary-700','border-b-2','border-primary-600');
          // Update content
          if (btn.dataset.tab === 'rules-templates') {
            // Prefer using the page's static templates content if present, otherwise inject a simple layout
            if (templatesContent) {
              rulesTabContent.innerHTML = templatesContent.outerHTML;
            } else {
              rulesTabContent.innerHTML = `
                <div class="grid grid-cols-4 gap-4">
                  <div class="col-span-1">
                    <div class="flex items-center justify-between mb-3">
                      <div class="font-medium">è§„åˆ™æ¨¡ç‰ˆ</div>
                      <button id="btnAddTemplateInTab" class="px-2 py-1 rounded bg-primary-600 text-white text-xs">æ–°å¢</button>
                    </div>
                    <div id="templateList" class="space-y-2"></div>
                  </div>
                  <div class="col-span-3">
                    <div id="templateMetaInTab" class="mb-2 text-sm text-gray-600">æœªé€‰æ‹©æ¨¡ç‰ˆ</div>
                    <div id="templateContentInTab" class="p-3 border rounded bg-white min-h-[160px]">è¯·ä»å·¦ä¾§é€‰æ‹©æ¨¡ç‰ˆæŸ¥çœ‹è¯¦æƒ…</div>
                  </div>
                </div>`;
            }

            // Rebind and initialize after DOM insertion
            setTimeout(() => {
              try {
                renderTemplates();
                if (templates && templates.length > 0) selectTemplate(templates[0]);
                // update strategy template selects
                try { populateStrategyTemplateSelect('builtin'); populateStrategyTemplateSelect('custom'); } catch (e) {}

                // Bind both add-template buttons (tab header and any left-list add button if present)
                const btnAddTemplateRuleEl = document.getElementById('btnAddTemplateRule');
                if (btnAddTemplateRuleEl) {
                  btnAddTemplateRuleEl.onclick = () => openTemplateModal();
                }
                const btnAddTemplateInTab = document.getElementById('btnAddTemplateInTab');
                if (btnAddTemplateInTab) {
                  btnAddTemplateInTab.onclick = () => openTemplateModal();
                }

                // Bind search & sort controls if present
                Array.from(document.querySelectorAll('#templateSearchInput')).forEach(el => el.addEventListener('input', () => renderTemplates()));
                Array.from(document.querySelectorAll('#templateSortSelect')).forEach(el => el.addEventListener('change', () => renderTemplates()));
              } catch (err) {
                console.error('init templates tab error', err);
              }
            }, 0);
          } else if (btn.dataset.tab === 'rules-watermark') {
            // Regenerate watermark rules content dynamically
            tabContents['rules-watermark'] = generateWatermarkRulesTabContent();
            rulesTabContent.innerHTML = tabContents['rules-watermark'];
            bindWMRuleEvents();
            // Rebind add button event
            const btnAddWMRuleInTab = document.getElementById('btnAddWMRuleInTab');
            if (btnAddWMRuleInTab) {
              btnAddWMRuleInTab.addEventListener('click', () => openWMRuleModal());
            }
          } else {
            rulesTabContent.innerHTML = tabContents[btn.dataset.tab] || '';
          }
        });
        // Set initial content - default to waterMark tab
        const defaultTab = rulesTabs.querySelector('[data-tab="rules-watermark"]') || rulesTabs.querySelector('[data-tab]');
        if (defaultTab) {
          defaultTab.classList.add('bg-primary-50','text-primary-700','border-b-2','border-primary-600');
          if (defaultTab.dataset.tab === 'rules-watermark') {
            rulesTabContent.innerHTML = generateWatermarkRulesTabContent();
            bindWMRuleEvents();
            const btnAddWMRuleInTab = document.getElementById('btnAddWMRuleInTab');
            if (btnAddWMRuleInTab) {
              btnAddWMRuleInTab.addEventListener('click', () => openWMRuleModal());
            }
          } else if (defaultTab.dataset.tab === 'rules-templates') {
            // render templates tab initial content and bind
            rulesTabContent.innerHTML = templatesContent ? templatesContent.outerHTML : '';
            setTimeout(() => {
              try {
                renderTemplates();
                if (templates && templates.length > 0) selectTemplate(templates[0]);
                try { populateStrategyTemplateSelect('builtin'); populateStrategyTemplateSelect('custom'); } catch (e) {}
                const btnAddTemplateRuleEl = document.getElementById('btnAddTemplateRule');
                if (btnAddTemplateRuleEl) btnAddTemplateRuleEl.onclick = () => openTemplateModal();
                const btnAddTemplateInTab = document.getElementById('btnAddTemplateInTab');
                if (btnAddTemplateInTab) btnAddTemplateInTab.onclick = () => openTemplateModal();
                Array.from(document.querySelectorAll('#templateSearchInput')).forEach(el => el.addEventListener('input', () => renderTemplates()));
                Array.from(document.querySelectorAll('#templateSortSelect')).forEach(el => el.addEventListener('change', () => renderTemplates()));
              } catch (err) { console.error(err); }
            },0);
          } else {
            rulesTabContent.innerHTML = tabContents[defaultTab.dataset.tab] || '';
          }
        }
      }


      // Templates page demo data
      const templates = [
        { id: 'TPL-01', source: 'built-in', name: 'å¯¹å¤–å…±äº«æŠ¥è¡¨', desc: 'å¯¹æŠ¥è¡¨å¯¼å‡ºæ·»åŠ åŠé€æ˜æ°´å°ï¼Œå¹¶å¯¹æ•æ„Ÿåˆ—è„±æ•', rules: ['æ–‡æ¡£å¤–å‘å¼ºæ°´å°','æ‰‹æœºå·è„±æ•'], desens: ['æ‰‹æœºå·è„±æ•ï¼ˆä¿ç•™å‰ä¸‰ä½ï¼‰','å§“åé¦–å­—æ¯ä¿ç•™'] },
        { id: 'TPL-02', source: 'custom', name: 'å›¾ç‰‡å¤–å‘', desc: 'å›¾ç‰‡æ·»åŠ å¼ºæ°´å°ï¼Œåº•éƒ¨æ ‡è¯†ä¸šåŠ¡ä¸è´£ä»»äºº', rules: ['å›¾ç‰‡æ°´å°ï¼ˆåŠé€æ˜ï¼‰','è´£ä»»äººæ ‡è®°'], desens: ['å›¾ç‰‡æ•æ„Ÿæ ‡è¯†'] }
      ];
      const templateList = document.getElementById('templateList');
      const templateContent = document.getElementById('templateContent');
      const templateMeta = document.getElementById('templateMeta');

      function renderTemplates() {
        // render into all containers that have id 'templateList' (handles duplicate/static sections)
        const listEls = Array.from(document.querySelectorAll('#templateList'));
        if (!listEls || listEls.length === 0) return;

        // Helper: get value from the first visible control with this id
        const getVisibleVal = (id) => {
          const nodes = Array.from(document.querySelectorAll('#' + id));
          for (const n of nodes) {
            if (n.offsetParent !== null) return n.value || '';
          }
          return '';
        };

        const q = (getVisibleVal('templateSearchInput') || '').trim().toLowerCase();
        const sortVal = getVisibleVal('templateSortSelect') || 'name-asc';

        let list = Array.from(templates || []);
        if (q) {
          list = list.filter(t => (t.name || '').toLowerCase().includes(q) || (t.id || '').toLowerCase().includes(q) || (t.desc || '').toLowerCase().includes(q));
        }
        // Sorting
        list.sort((a,b) => {
          if (sortVal === 'name-asc') return (a.name||'').localeCompare(b.name||'');
          if (sortVal === 'name-desc') return (b.name||'').localeCompare(a.name||'');
          if (sortVal === 'source-asc') return (a.source||'').localeCompare(b.source||'');
          if (sortVal === 'source-desc') return (b.source||'').localeCompare(a.source||'');
          return 0;
        });

        // Render into each list container
        listEls.forEach(listEl => {
          listEl.innerHTML = '';
          list.forEach((t, idx) => {
            // compute original index in templates array
            const origIdx = templates.findIndex(x => x.id === t.id);
            const item = document.createElement('div');
            item.className = 'w-full p-3 rounded border hover:border-primary-300 hover:bg-primary-50 transition-colors';
            item.innerHTML = `
              <div class="flex items-center justify-between">
                <button class="flex-1 text-left template-item-btn" data-idx="${origIdx}">
                  <div class="font-medium text-sm">${t.name}</div>
                  <div class="text-xs text-gray-500">${t.id}</div>
                </button>
                <div class="flex items-center gap-1 ml-2">
                  <button class="edit-template-btn text-primary-600 hover:text-primary-700 p-1" data-idx="${origIdx}" title="ç¼–è¾‘">
                    <i class="fa-solid fa-pen text-xs"></i>
                  </button>
                  <button class="delete-template-btn text-red-600 hover:text-red-700 p-1" data-idx="${origIdx}" title="åˆ é™¤">
                    <i class="fa-solid fa-trash text-xs"></i>
                  </button>
                </div>
              </div>
            `;
            // Bind click event for template selection
            item.querySelector('.template-item-btn').onclick = () => selectTemplate(t);
            // Bind edit/delete events
            item.querySelector('.edit-template-btn').onclick = (e) => {
              e.stopPropagation();
              openTemplateModal(parseInt(e.currentTarget.dataset.idx));
            };
            item.querySelector('.delete-template-btn').onclick = (e) => {
              e.stopPropagation();
              if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡ç‰ˆå—ï¼Ÿ')) {
                const delIdx = parseInt(e.currentTarget.dataset.idx);
                templates.splice(delIdx, 1);
                // re-render for all containers
                renderTemplates();
                // Clear content if deleted template was selected
                const templateContentInTab = document.getElementById('templateContentInTab');
                const templateMetaInTab = document.getElementById('templateMetaInTab');
                if (templateContentInTab) {
                  templateContentInTab.innerHTML = '<div class="flex items-center justify-center h-64 text-gray-400 text-sm">è¯·é€‰æ‹©å·¦ä¾§æ¨¡ç‰ˆæŸ¥çœ‹è¯¦æƒ…</div>';
                }
                if (templateMetaInTab) {
                  templateMetaInTab.textContent = 'æœªé€‰æ‹©æ¨¡ç‰ˆ';
                }
              }
            };
            listEl.appendChild(item);
          });
        });
      }
      
      function openTemplateModal(editIndex = null) {
        let modal = document.getElementById('addTemplateModal');
        // If modal markup is missing (older static area), create a minimal modal to avoid runtime errors
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'addTemplateModal';
          modal.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
          modal.innerHTML = `
            <div class="bg-white rounded-lg w-full max-w-xl overflow-hidden">
              <div class="p-4 border-b flex items-center justify-between">
                <div class="font-medium">æ–°å¢è§„åˆ™æ¨¡ç‰ˆ</div>
                <button class="modal-close text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
              </div>
              <div class="p-4">
                <form id="templateForm" class="space-y-4 text-sm">
                  <label class="block"><span class="text-gray-600">æ¨¡ç‰ˆåç§°</span><input id="templateName" class="mt-1 w-full border rounded px-3 py-2" /></label>
                  <label class="block"><span class="text-gray-600">æè¿°</span><input id="templateDesc" class="mt-1 w-full border rounded px-3 py-2" /></label>
                  <div id="templateRulesList" class="space-y-2"></div>
                </form>
              </div>
              <div class="p-4 border-t flex justify-end gap-2">
                <button class="modal-close px-4 py-2 rounded border hover:bg-gray-50">å–æ¶ˆ</button>
                <button type="submit" form="templateForm" class="px-4 py-2 rounded bg-primary-600 text-white hover:bg-primary-700">ä¿å­˜æ¨¡ç‰ˆ</button>
              </div>
            </div>`;
          document.body.appendChild(modal);
          // bind close buttons
          modal.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));
        }
        const title = modal.querySelector('.font-medium');
        if (editIndex !== null && templates[editIndex]) {
          // Edit mode
          const t = templates[editIndex];
          title.textContent = 'ç¼–è¾‘è§„åˆ™æ¨¡ç‰ˆ';
          const nameEl = document.getElementById('templateName');
          const descEl = document.getElementById('templateDesc');
          if (nameEl) nameEl.value = t.name || '';
          if (descEl) descEl.value = t.desc || '';
          document.getElementById('templateForm').dataset.editIndex = editIndex;
        } else {
          // Add mode
          title.textContent = 'æ–°å¢è§„åˆ™æ¨¡ç‰ˆ';
          document.getElementById('templateForm').reset();
          document.getElementById('templateForm').dataset.editIndex = '';
        }
        modal.classList.remove('hidden');
      }
      function selectTemplate(t) {
        // helper: pick the first visible element with given id (handles duplicate IDs / injected copies)
        const getVisibleEl = (id) => {
          const nodes = Array.from(document.querySelectorAll('#' + id));
          for (const n of nodes) {
            if (n.offsetParent !== null) return n;
          }
          return document.getElementById(id);
        };
        const metaEl = templateMeta || getVisibleEl('templateMetaInTab');
        const contentEl = templateContent || getVisibleEl('templateContentInTab');
        if (metaEl) metaEl.textContent = `${t.id} Â· ${t.name}`;
        if (contentEl) {
         //
         
          // è¯¦æƒ…åŒºåŒ…å«ä¸¤ä¸ªé¡µç­¾ï¼šè„±æ•è§„åˆ™ & æ°´å°è§„åˆ™ï¼Œæ°´å°è§„åˆ™é¡µç­¾ä¸‹æœ‰æ–°å¢è§„åˆ™æŒ‰é’®
          contentEl.innerHTML = `
            <div class="mb-4 text-gray-600">${t.desc || ''}</div>
            <div class="mb-3">
              <nav class="flex gap-2 text-sm" id="templateDetailTabs">
                <button data-tab="desens" class="tab-btn px-3 py-1.5 rounded bg-primary-50 text-primary-700 border-b-2 border-primary-600">è„±æ•è§„åˆ™</button>
                <button data-tab="watermark" class="tab-btn px-3 py-1.5 rounded hover:bg-gray-50">æ°´å°è§„åˆ™</button>
              </nav>
            </div>
            <div id="templateDetailContent">
              <!-- é»˜è®¤æ˜¾ç¤ºè„±æ•è§„åˆ™ -->
              <div id="tpl-desens" class="tpl-detail">
                <div class="font-medium mb-2">è„±æ•è§„åˆ™</div>
                <div class="text-sm text-gray-700">
                  <ul class="list-disc pl-5">
                    ${ (t.desens && t.desens.length ? t.desens : ['æ‰‹æœºå·è„±æ•ï¼ˆä¿ç•™å‰ä¸‰ä½ï¼‰','å§“åé¦–å­—æ¯ä¿ç•™']).map(d => `<li>${d}</li>`).join('') }
                  </ul>
                </div>
              </div>
              <div id="tpl-watermark" class="tpl-detail hidden">
                <div class="flex items-center justify-between mb-3">
                  <div class="font-medium">æ°´å°è§„åˆ™</div>
                  <div class="flex items-center gap-2">
                    <input id="tpl-rule-search" placeholder="æœç´¢è§„åˆ™" class="border rounded px-3 py-1 text-sm text-gray-600" />
                    <button id="addRuleToTemplateBtn" class="px-3 py-1 rounded bg-primary-600 text-white text-sm hover:bg-primary-700">æ–°å¢è§„åˆ™</button>
                  </div>
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full text-left text-sm">
                    <thead>
                      <tr class="text-xs text-gray-600 border-b">
                        <th class="px-3 py-2">è§„åˆ™åç§°</th>
                        <th class="px-3 py-2">æè¿°</th>
                        <th class="px-3 py-2">æ°´å°ç®—æ³•</th>
                        <th class="px-3 py-2">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="tpl-watermark-tbody">
                      ${ t.rules && t.rules.length ? t.rules.map(rname => {
                        const found = wmRules.find(w => w.name === rname);
                        if (found) {
                          return `<tr data-name="${found.name}" class="border-b last:border-b-0">
                                    <td class="px-3 py-3">${found.id} Â· ${found.name}</td>
                                    <td class="px-3 py-3 text-gray-600">${found.desc || '-'}</td>
                                    <td class="px-3 py-3">${found.waterAlg || '-'} / ${found.encAlg || '-'}</td>
                                    <td class="px-3 py-3">
                                      <button class="edit-wm-in-template text-primary-600 text-sm mr-4" data-wid="${found.id}">ç¼–è¾‘</button>
                                      <button class="delete-wm-in-template text-red-600 text-sm" data-wid="${found.id}">åˆ é™¤</button>
                                    </td>
                                  </tr>`;
                        } else {
                          return `<tr class="border-b last:border-b-0"><td class="px-3 py-3">${rname}</td><td class="px-3 py-3 text-gray-600">ï¼ˆè§„åˆ™åº“ä¸­æœªæ‰¾åˆ°ï¼‰</td><td class="px-3 py-3">-</td><td class="px-3 py-3"><button class="delete-wm-in-template text-red-600 text-sm" data-name="${rname}">åˆ é™¤</button></td></tr>`;
                        }
                      }).join('') : `<tr><td class="px-3 py-4 text-gray-500" colspan="4">æš‚æ— æ°´å°è§„åˆ™</td></tr>` }
                    </tbody>
                  </table>
                </div>
              </div>
            </div>`;

          // ç»‘å®šè¯¦æƒ…é¡µç­¾åˆ‡æ¢
          const tabs = contentEl.querySelector('#templateDetailTabs');
          if (tabs) {
            tabs.addEventListener('click', (e) => {
              const btn = e.target.closest('[data-tab]');
              if (!btn) return;
              tabs.querySelectorAll('button').forEach(b => b.classList.remove('bg-primary-50','text-primary-700','border-b-2','border-primary-600'));
              btn.classList.add('bg-primary-50','text-primary-700','border-b-2','border-primary-600');
              const tab = btn.dataset.tab;
              const des = contentEl.querySelector('#tpl-desens');
              const wat = contentEl.querySelector('#tpl-watermark');
              if (tab === 'desens') { des.classList.remove('hidden'); wat.classList.add('hidden'); }
              else { des.classList.add('hidden'); wat.classList.remove('hidden'); }
            });
            // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ª
            const firstBtn = tabs.querySelector('[data-tab]');
            if (firstBtn) {
              firstBtn.classList.add('bg-primary-50','text-primary-700','border-b-2','border-primary-600');
            }
          }
          // æ–°å¢è§„åˆ™æŒ‰é’®äº¤äº’ & æœç´¢ï¼ˆç®€å•è¿‡æ»¤ï¼‰
          const addRuleBtn = contentEl.querySelector('#addRuleToTemplateBtn');
          if (addRuleBtn) {
            addRuleBtn.addEventListener('click', () => {
              // æ‰“å¼€æ–°å¢æ°´å°è§„åˆ™å¼¹çª—ï¼Œä¿å­˜ååŒæ­¥åˆ°è§„åˆ™åº“å¹¶æ·»åŠ åˆ°å½“å‰æ¨¡ç‰ˆ
              openWMRuleModal(null, (newRule) => {
                // Avoid duplicate by id/name
                const exists = wmRules.find(w => w.id === newRule.id || w.name === newRule.name);
                if (!exists) wmRules.push(newRule);
                t.rules = t.rules || [];
                t.rules.push(newRule.name);
                renderWMRules();
                selectTemplate(t); // åˆ·æ–°è¯¦æƒ…
                try { populateTemplateRuleSelect(); } catch (e) {}
              });
            });
          }
          const tplSearch = contentEl.querySelector('#tpl-rule-search');
          if (tplSearch) {
            tplSearch.addEventListener('input', (e) => {
              const v = e.target.value.trim().toLowerCase();
              const tbody = contentEl.querySelector('#tpl-watermark-tbody');
              if (!tbody) return;
              Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                const text = (tr.textContent||'').toLowerCase();
                tr.style.display = (!v || text.includes(v)) ? '' : 'none';
              });
            });
          }

          // ç»‘å®šæ¨¡ç‰ˆä¸­æ°´å°è§„åˆ™çš„ç¼–è¾‘/åˆ é™¤æŒ‰é’®ï¼Œä¿æŒä¸è§„åˆ™åº“åŒå‘åŒæ­¥
          const wmEditBtns = contentEl.querySelectorAll('.edit-wm-in-template');
          wmEditBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const wid = btn.dataset.wid;
              const wmIdx = wmRules.findIndex(w => w.id === wid);
              if (wmIdx === -1) return alert('æœªåœ¨è§„åˆ™åº“ä¸­æ‰¾åˆ°è¯¥è§„åˆ™');
              const oldName = wmRules[wmIdx].name;
              // ç¼–è¾‘ï¼šé€šè¿‡å›è°ƒæŠŠæ›´æ–°åŒæ­¥å›æ¨¡ç‰ˆ
              openWMRuleModal(wmIdx, (newRule) => {
                // replace in rule library
                wmRules[wmIdx] = newRule;
                // update template rule names if changed
                t.rules = t.rules.map(n => n === oldName ? newRule.name : n);
                renderWMRules();
                selectTemplate(t);
                try { populateTemplateRuleSelect(); } catch (e) {}
              });
            });
          });

          const wmDelBtns = contentEl.querySelectorAll('.delete-wm-in-template');
          wmDelBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const wid = btn.dataset.wid;
              const nameAttr = btn.dataset.name;
              if (wid) {
                const wmIdx = wmRules.findIndex(w => w.id === wid);
                if (wmIdx === -1) return alert('æœªåœ¨è§„åˆ™åº“ä¸­æ‰¾åˆ°è¯¥è§„åˆ™');
                const confirmDel = confirm('æ˜¯å¦åŒæ—¶ä»è§„åˆ™åº“ä¸­åˆ é™¤è¯¥è§„åˆ™ï¼ŸæŒ‰ç¡®å®šï¼šåŒæ—¶åˆ é™¤ï¼›æŒ‰å–æ¶ˆï¼šä»…ä»å½“å‰æ¨¡ç‰ˆç§»é™¤');
                if (confirmDel) {
                  const oldName = wmRules[wmIdx].name;
                  wmRules.splice(wmIdx, 1);
                  // remove from this template
                  t.rules = t.rules.filter(n => n !== oldName);
                } else {
                  // ä»…ä»æ¨¡ç‰ˆç§»é™¤
                  const targetName = nameAttr || (wmRules[wmIdx] && wmRules[wmIdx].name) || '';
                  t.rules = t.rules.filter(n => n !== targetName);
                }
                renderWMRules();
                selectTemplate(t);
                try { populateTemplateRuleSelect(); } catch (e) {}
              } else if (nameAttr) {
                // rule not in library, just remove from template
                t.rules = t.rules.filter(n => n !== nameAttr);
                selectTemplate(t);
              }
            });
          });
        }
      }
      // å…¼å®¹æ—§åçš„åŒ…è£…å‡½æ•°ï¼šç»Ÿä¸€è°ƒç”¨æ­£ç¡®çš„ openWMRuleModalï¼ˆæ”¯æŒå›è°ƒï¼‰
      function openWmRuleModal(editIndex = null, onSaveCb) {
        return openWMRuleModal(editIndex, onSaveCb);
      }
      renderTemplates();
      // è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡ç‰ˆå¹¶å±•ç¤ºï¼ˆæä¾›æ˜¾ç¤ºæ ·ä¾‹ï¼‰
      if (templates && templates.length > 0) {
        selectTemplate(templates[0]);
        // å¦‚æœå³ä¾§ä»æ˜¯å ä½æ–‡æœ¬ï¼ˆæœªè¢«æ¸²æŸ“ï¼‰ï¼Œå°è¯•å†æ¬¡æ¸²æŸ“ç¬¬ä¸€ä¸ªæ¨¡ç‰ˆï¼ˆå…œåº•ï¼‰
        try {
          const contentEl = document.getElementById('templateContentInTab');
          if (contentEl && contentEl.textContent && contentEl.textContent.trim().includes('è¯·é€‰æ‹©å·¦ä¾§æ¨¡ç‰ˆæŸ¥çœ‹è¯¦æƒ…')) {
            selectTemplate(templates[0]);
          }
        } catch (e) {}
      }

      // ç­–ç•¥æ¨¡ç‰ˆä¸‹æ‹‰ï¼ˆåŸºäºæ¨¡ç‰ˆåˆ—è¡¨ï¼‰ - å…¼å®¹æ—§å
      function populateStrategyTemplateSelect(kind) {
        const sel = document.getElementById('strategyTemplateSelect');
        if (!sel) return;
        const list = templates.filter(t => (kind === 'builtin') ? (t.source === 'built-in') : (t.source === 'custom'));
        sel.innerHTML = list.map(t => `<option value="${t.name}">${t.id} Â· ${t.name}</option>`).join('');
      }

      // ç­–ç•¥æ°´å°è§„åˆ™ä¸‹æ‹‰ï¼ˆåŸºäºæ°´å°è§„åˆ™åˆ—è¡¨ï¼‰
      function populateStrategyRuleSelect() {
        const sel = document.getElementById('strategyRuleSelect');
        if (!sel) return;
        sel.innerHTML = wmRules.map(r => `<option value="${r.name}">${r.id} Â· ${r.name}</option>`).join('');
        const selTemplate = document.getElementById('strategyRuleSelectTemplate');
        if (selTemplate) {
          selTemplate.innerHTML = wmRules.map(r => `<option value="${r.name}">${r.id} Â· ${r.name}</option>`).join('');
        }
      }

      // åˆå§‹åŒ–å¡«å……ï¼ˆé»˜è®¤å†…ç½®ï¼‰
      populateStrategyTemplateSelect('builtin');
      populateStrategyRuleSelect();

      // Watermark Rule Form Submit Handler
  const wmRuleForm = document.getElementById('wmRuleForm');
  const addWMRuleModal = document.getElementById('addWMRuleModal');
  const wmRuleModalTitle = document.getElementById('wmRuleModalTitle');
  // å½“ä»æ¨¡ç‰ˆè¯¦æƒ…æ–°å¢è§„åˆ™æ—¶ï¼Œå¯é€šè¿‡å›è°ƒæ¥æ”¶æ–°è§„åˆ™ï¼Œé¿å…é‡å¤å…¥åº“
  let currentWmRuleOnSaveCb = null;
      
      function openWMRuleModal(editIndex = null, onSaveCb = null) {
        // ä¿å­˜å›è°ƒï¼ˆå¯ä¸º nullï¼‰
        currentWmRuleOnSaveCb = typeof onSaveCb === 'function' ? onSaveCb : null;
        const modal = document.getElementById('addWMRuleModal');
        const title = document.getElementById('wmRuleModalTitle');
        const form = document.getElementById('wmRuleForm');

        modal.classList.remove('hidden');
        // Use setTimeout to ensure the modal is rendered before attaching listeners and setting values
        setTimeout(() => {
          initWMRuleFormInteractions();

          if (editIndex !== null && wmRules[editIndex]) {
            // Edit mode
            const rule = wmRules[editIndex];
            title.textContent = 'ç¼–è¾‘æ°´å°è§„åˆ™';
            // Store edit index in form dataset for submit handler
            form.dataset.editIndex = editIndex;
            // Set form values with guards
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
            setVal('wmRuleName', rule.name || '');
            setVal('wmAlgorithm', (rule.waterAlg === 'DCT' || rule.waterAlg === 'DWT') ? 'frequency' : 'identifier');
            setVal('wmCarrier', rule.carrier || 'jpg');
            setVal('wmDescription', rule.desc || '');
            setVal('clearWatermarkContent', rule.clearWatermarkContent || '');
            setVal('clearFontFamily', rule.clearFontFamily || 'Arial');
            setVal('clearFontSize', rule.clearFontSize || '12');
            setVal('clearFontWeight', rule.clearFontWeight || 'normal');
            setVal('clearFontColor', rule.clearFontColor || '#000000');
            setVal('clearBgColor', rule.clearBgColor || '#ffffff');
            setVal('clearImgWidth', rule.clearImgWidth || '');
            setVal('clearImgHeight', rule.clearImgHeight || '');
            setVal('clearOpacity', rule.clearOpacity || '0.5');
            setVal('clearArrangement', rule.clearArrangement || 'tilt');
            setVal('clearAngle', rule.clearAngle || '0');
            setVal('clearPosition', rule.clearPosition || 'center');
            setVal('clearHorizontalSpacing', rule.clearHorizontalSpacing || '0');
            setVal('clearVerticalSpacing', rule.clearVerticalSpacing || '0');
            setVal('secretAlgorithmMode', rule.secretMode || 'dct');
            // If rule has clear/secret watermark info, check appropriate boxes
            if (rule.type === 'clear' || rule.type === 'mixed') document.getElementById('wmTypeClear').checked = true;
            if (rule.type === 'secret' || rule.type === 'mixed') document.getElementById('wmTypeSecret').checked = true;
          } else {
            // Add mode
            title.textContent = 'æ–°å¢æ°´å°è§„åˆ™';
            form.dataset.editIndex = '';
            if (form) form.reset();
            // Clear checkboxes
            const chkClear = document.getElementById('wmTypeClear');
            const chkSecret = document.getElementById('wmTypeSecret');
            if (chkClear) chkClear.checked = false;
            if (chkSecret) chkSecret.checked = false;
          }
          // Trigger visibility update after setting values
          try {
            const event = new Event('change');
            document.getElementById('wmAlgorithm')?.dispatchEvent(event);
            document.getElementById('wmTypeClear')?.dispatchEvent(event);
            document.getElementById('wmTypeSecret')?.dispatchEvent(event);
          } catch (e) {}
        }, 0);
      }
      
      // Handle edit and delete buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-wm-rule')) {
          const idx = parseInt(e.target.dataset.idx);
          openWMRuleModal(idx);
        } else if (e.target.classList.contains('delete-wm-rule')) {
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
            const idx = parseInt(e.target.dataset.idx);
            wmRules.splice(idx, 1);
            renderWMRules();
            // Update tab if active
            const activeTab = rulesTabs?.querySelector('[data-tab].bg-primary-50');
            if (activeTab && activeTab.dataset.tab === 'rules-watermark') {
              tabContents['rules-watermark'] = generateWatermarkRulesTabContent();
              rulesTabContent.innerHTML = tabContents['rules-watermark'];
              bindWMRuleEvents();
            }
          }
        }
      });
      
      function bindWMRuleEvents() {
        // Bind edit/delete events in tab content
        document.querySelectorAll('.edit-wm-rule').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.idx);
            openWMRuleModal(idx);
          });
        });
        document.querySelectorAll('.delete-wm-rule').forEach(btn => {
          btn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
              const idx = parseInt(btn.dataset.idx);
              wmRules.splice(idx, 1);
              tabContents['rules-watermark'] = generateWatermarkRulesTabContent();
              rulesTabContent.innerHTML = tabContents['rules-watermark'];
              bindWMRuleEvents();
            }
          });
        });
      }
      
      if (wmRuleForm) {
        wmRuleForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const editIndex = wmRuleForm.dataset.editIndex || '';
          // Collect form values with guards
          const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
          const algorithm = getVal('wmAlgorithm');
          const carrier = getVal('wmCarrier');
          const description = getVal('wmDescription');
          const typeClear = document.getElementById('wmTypeClear')?.checked || false;
          const typeSecret = document.getElementById('wmTypeSecret')?.checked || false;
          const clearWatermarkContent = getVal('clearWatermarkContent');
          const clearFontFamily = getVal('clearFontFamily');
          const clearFontSize = getVal('clearFontSize');
          const clearFontWeight = getVal('clearFontWeight');
          const clearFontColor = getVal('clearFontColor');
          const clearArrangement = getVal('clearArrangement');
          const clearAngle = getVal('clearAngle');
          const clearPosition = getVal('clearPosition');
          const clearHorizontalSpacing = getVal('clearHorizontalSpacing');
          const clearVerticalSpacing = getVal('clearVerticalSpacing');
          const secretMode = getVal('secretAlgorithmMode');

          // Determine watermark type
          let wmType = 'none';
          if (typeClear && typeSecret) wmType = 'mixed';
          else if (typeClear) wmType = 'clear';
          else if (typeSecret) wmType = 'secret';

          // Build watermark algorithm value
          let waterAlg = algorithm === 'frequency' ? 'DCT' : 'identifier';
          if (algorithm === 'frequency' && typeSecret) waterAlg = secretMode || 'DCT';

          const clearBgColor = getVal('clearBgColor');
          const clearImgWidth = getVal('clearImgWidth');
          const clearImgHeight = getVal('clearImgHeight');
          const clearOpacity = getVal('clearOpacity');

          const ruleData = {
            id: `WM-${String(wmRules.length + 1).padStart(3,'0')}`,
            name: getVal('wmRuleName') || `${carrier}-${wmType}`,
            type: wmType,
            source: 'custom',
            waterAlg: waterAlg,
            encAlg: algorithm === 'frequency' ? 'RSA' : 'None',
            desc: description,
            carrier: carrier,
            // Clear watermark settings
            clearWatermarkContent: typeClear ? clearWatermarkContent : null,
            clearFontFamily: typeClear ? clearFontFamily : null,
            clearFontSize: typeClear ? clearFontSize : null,
            clearFontWeight: typeClear ? clearFontWeight : null,
            clearFontColor: typeClear ? clearFontColor : null,
            clearBgColor: typeClear ? clearBgColor : null,
            clearImgWidth: typeClear ? clearImgWidth : null,
            clearImgHeight: typeClear ? clearImgHeight : null,
            clearOpacity: typeClear ? clearOpacity : null,
            clearArrangement: typeClear ? clearArrangement : null,
            clearAngle: typeClear ? clearAngle : null,
            clearPosition: typeClear ? clearPosition : null,
            clearHorizontalSpacing: typeClear ? clearHorizontalSpacing : null,
            clearVerticalSpacing: typeClear ? clearVerticalSpacing : null,
            // Secret watermark settings
            secretMode: typeSecret ? secretMode : null,
            updated: new Date().toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(/\//g, '-')
          };
          // å¦‚æœå­˜åœ¨å›è°ƒï¼Œäº¤ç”±å›è°ƒå¤„ç†æ–°è§„åˆ™ï¼ˆæ¯”å¦‚åŒæ­¥åˆ°æ¨¡ç‰ˆå¹¶æ·»åŠ åˆ°è§„åˆ™åº“ï¼‰ï¼Œå¹¶æ¸…é™¤å›è°ƒ
          if (currentWmRuleOnSaveCb) {
            try { currentWmRuleOnSaveCb(ruleData); } catch (err) { console.error('onSaveCb error', err); }
            currentWmRuleOnSaveCb = null;
            // å…³é—­å¼¹çª—å¹¶é‡ç½®è¡¨å•
            wmRuleForm.reset();
            addWMRuleModal.classList.add('hidden');
            // æ›´æ–°ä¸‹æ‹‰/åˆ—è¡¨ç­‰æ˜¾ç¤ºï¼ˆå›è°ƒå†…éƒ¨å¯èƒ½å·²ç»å¤„ç†ï¼Œæ­¤å¤„å†å°è¯•åˆ·æ–°ä»¥ä¿æŒä¸€è‡´ï¼‰
            try { populateTemplateRuleSelect(); renderWMRules(); } catch (e) {}
          } else {
            if (editIndex !== '') {
              // Edit existing
              wmRules[parseInt(editIndex)] = ruleData;
            } else {
              // Add new
              wmRules.push(ruleData);
            }
            renderWMRules();
            wmRuleForm.reset();
            addWMRuleModal.classList.add('hidden');
            // æ›´æ–°æ¨¡ç‰ˆ/ç­–ç•¥ä¸­çš„ä¸‹æ‹‰æ•°æ®
            try { populateTemplateRuleSelect(); } catch (e) { /* ignore */ }
          }
          // æ›´æ–°æ¨¡ç‰ˆ/ç­–ç•¥ä¸­çš„ä¸‹æ‹‰æ•°æ®
          try { populateTemplateRuleSelect(); } catch (e) { /* ignore */ }
          // Update watermark rules tab if it's active
          const activeTab = rulesTabs?.querySelector('[data-tab].bg-primary-50');
          if (activeTab && activeTab.dataset.tab === 'rules-watermark') {
            tabContents['rules-watermark'] = generateWatermarkRulesTabContent();
            rulesTabContent.innerHTML = tabContents['rules-watermark'];
            bindWMRuleEvents();
            // Rebind add button event
            const btnAddWMRuleInTab = document.getElementById('btnAddWMRuleInTab');
            if (btnAddWMRuleInTab) {
              btnAddWMRuleInTab.addEventListener('click', () => openWMRuleModal());
            }
          }
        });
      }
      
      // Bind add button
      const btnAddWMRule = document.getElementById('btnAddWMRule');
      if (btnAddWMRule) {
        btnAddWMRule.addEventListener('click', () => openWMRuleModal());
      }

      

      // åœ¨æ‰“å¼€å¼¹çª—æ—¶åˆå§‹åŒ–äº¤äº’
      const originalOpenWMRuleModal = openWMRuleModal;
      openWMRuleModal = function(editIndex = null, onSaveCb = null) {
        originalOpenWMRuleModal(editIndex, onSaveCb);
        // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå·²æ¸²æŸ“
        setTimeout(() => {
          initWMRuleFormInteractions();
        }, 10);
      };
      // Template form handler
      const templateForm = document.getElementById('templateForm');
      const addTemplateModal = document.getElementById('addTemplateModal');
      let templateRules = [];
      
      // Handle add rule button in template form
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('add-rule-btn')) {
          e.preventDefault();
          const input = e.target.previousElementSibling;
          const ruleName = input.value.trim();
          if (ruleName) {
            templateRules.push(ruleName);
            input.value = '';
            updateTemplateRulesList();
          }
        }
        // Handle remove rule
        if (e.target.classList.contains('remove-rule-btn')) {
          const idx = parseInt(e.target.dataset.idx);
          templateRules.splice(idx, 1);
          updateTemplateRulesList();
        }
      });

      function updateTemplateRulesList() {
        const listEl = document.getElementById('templateRulesList');
        if (listEl) {
          listEl.innerHTML = templateRules.map((r, idx) => `
            <div class="flex items-center gap-2 bg-gray-50 rounded px-3 py-2">
              <span class="flex-1 text-sm">${r}</span>
              <button type="button" class="remove-rule-btn text-red-600 hover:text-red-700" data-idx="${idx}">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          `).join('');
        }
      }

      if (templateForm && addTemplateModal) {
        templateForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const nameEl = document.getElementById('templateName');
          const descEl = document.getElementById('templateDesc');
          const selectedRules = []; // æ¨¡ç‰ˆåˆ›å»ºæ—¶åªä¿å­˜åç§°/æè¿°ï¼Œè§„åˆ™é€šè¿‡è¯¦æƒ…é¡µæ–°å¢
          const name = nameEl ? nameEl.value.trim() : '';
          const desc = descEl ? descEl.value.trim() : '';
          const editIndex = templateForm.dataset.editIndex;

          if (!name) {
            alert('è¯·å¡«å†™æ¨¡ç‰ˆåç§°');
            return;
          }

          if (editIndex !== '') {
            // Edit existing template
            const idx = parseInt(editIndex);
            templates[idx] = {
              ...templates[idx],
              name: name,
              desc: desc || 'æ— æè¿°',
              rules: [...selectedRules]
            };
          } else {
            // Add new template
            const n = templates.length + 1;
            const t = {
              id: `TPL-${String(n).padStart(2,'0')}`,
              source: 'custom',
              name: name,
              desc: desc || 'æ— æè¿°',
              rules: [],
              desens: []
            };
            templates.push(t);
          }

          templateForm.reset();
          // æ¸…é™¤é€‰æ‹©ï¼ˆå¦‚æœå­˜åœ¨ templateRuleSelectï¼‰
          const selElem = document.getElementById('templateRuleSelect');
          if (selElem) Array.from(selElem.options).forEach(o => o.selected = false);
          addTemplateModal.classList.add('hidden');
          // Always update template lists (all templateList containers)
          try { renderTemplates(); } catch (e) { console.error('renderTemplates error', e); }
          // Select the template that was just added/edited if possible
          const selectedIndex = editIndex !== '' ? parseInt(editIndex) : templates.length - 1;
          if (templates[selectedIndex]) {
            try { selectTemplate(templates[selectedIndex]); } catch (e) { console.error('selectTemplate error', e); }
          }
          // æ›´æ–°ç­–ç•¥ä¸‹æ‹‰ï¼ˆé»˜è®¤å¡«å……å†…ç½®æ¨¡ç‰ˆï¼‰
          populateStrategyTemplateSelect('builtin');
        });
      }

      // Bind add template buttons
      const bindAddTemplateButtons = () => {
        const btnAddTemplateInTab = document.getElementById('btnAddTemplateInTab');
        if (btnAddTemplateInTab) {
          btnAddTemplateInTab.addEventListener('click', () => {
            openTemplateModal();
          });
        }
      };
      
      // Bind add template buttons safely
      const btnAddTemplateRuleEl = document.getElementById('btnAddTemplateRule');
      if (btnAddTemplateRuleEl) {
        bindModal('btnAddTemplateRule', 'addTemplateModal');
      }
      bindAddTemplateButtons();

      // ä¾§æ èœå•ç‚¹å‡»åˆ‡æ¢é¡µé¢ï¼ˆç»‘å®šä¸€æ¬¡ï¼‰
      function initSidebarNav() {
        document.querySelectorAll('.nav-link').forEach(link => {
          // avoid double-binding
          if (link._hasNavBind) return;
          link._hasNavBind = true;
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const module = link.dataset.module;
            const page = link.dataset.page;
            if (module && page) {
              setActiveModule(module);
              setActivePage(module, page);
            }
          });
        });
      }

      // Initialize when DOM is ready
      function initializeApp() {
        try {
          console.log('Initializing app...');
        
        // ç»‘å®šå¯¼èˆªèœå•é¡¹
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const module = item.dataset.module;
            if (module && routeMap[module]) {
              setActiveModule(module);
              const menuGridDropdown = document.getElementById('menuGridDropdown');
              if (menuGridDropdown) {
                menuGridDropdown.classList.add('hidden');
              }
            }
          });
        });

  // Kick off router
  initRouter();

  // Ensure watermark rule modal interactions (æ˜æ°´å°/æš—æ°´å°ç­‰) are initialized
  try { if (typeof initWMRuleFormInteractions === 'function') initWMRuleFormInteractions(); } catch(e) { console.error('initWMRuleFormInteractions error', e); }
  // Ensure sidebar nav is bound
  try { initSidebarNav(); } catch(e) { console.error('initSidebarNav error', e); }

        // Grid Menu Dropdown
        const menuGridBtn = document.getElementById('menuGridBtn');
        const menuGridDropdown = document.getElementById('menuGridDropdown');
        console.log('Menu grid button:', menuGridBtn, 'Dropdown:', menuGridDropdown);
        if (menuGridBtn && menuGridDropdown) {
          console.log('Binding grid menu dropdown events...');
          menuGridBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            console.log('Grid button clicked, toggling dropdown');
            menuGridDropdown.classList.toggle('hidden');
          });
          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!menuGridBtn.contains(e.target) && !menuGridDropdown.contains(e.target)) {
              menuGridDropdown.classList.add('hidden');
            }
          });
          // Handle menu items with data-module
          menuGridDropdown.querySelectorAll('.menu-item[data-module]').forEach(item => {
            item.addEventListener('click', (e) => {
              e.preventDefault();
              const module = item.dataset.module;
              if (module && routeMap[module]) {
                setActiveModule(module);
                menuGridDropdown.classList.add('hidden');
              }
            });
          });
        }

        // Shield Icon - Rules Library Entry (ä¿®å¤ç‚¹)
        const shieldRulesBtn = document.getElementById('shieldRulesBtn');
        if (shieldRulesBtn) {
          shieldRulesBtn.addEventListener('click', () => {
            console.log('Shield rules button clicked');
            const module = shieldRulesBtn.dataset.module || 'rules';
            if (module && routeMap[module]) {
              setActiveModule(module);
              const firstPage = Object.keys(routeMap[module])[0];
              setActivePage(module, firstPage);
            }
          });
        }

        // Sidebar toggle (mobile)
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebar && sidebarToggle) {
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
          });
        }
        } catch (error) {
          console.error('Error initializing app:', error);
          // Fallback: show home view
          const homeView = document.getElementById('view-home');
          if (homeView) {
            homeView.classList.add('active');
          }
        }
      }

      // Global error handlers to capture uncaught exceptions and promise rejections
      window.onerror = function(message, source, lineno, colno, error) {
        console.error('Global error captured:', message, source, lineno, colno, error);
        try {
          const overlay = document.getElementById('errorOverlay');
          const msg = document.getElementById('errorOverlayMsg');
          if (msg) msg.textContent = `${message}\n${source}:${lineno}:${colno}\n${error && error.stack ? error.stack : ''}`;
          if (overlay) overlay.classList.remove('hidden');
        } catch (e) {}
      };
      window.addEventListener('unhandledrejection', function(evt) {
        console.error('Unhandled promise rejection', evt.reason);
        try {
          const overlay = document.getElementById('errorOverlay');
          const msg = document.getElementById('errorOverlayMsg');
          if (msg) msg.textContent = `UnhandledRejection: ${evt.reason && evt.reason.stack ? evt.reason.stack : String(evt.reason)}`;
          if (overlay) overlay.classList.remove('hidden');
        } catch (e) {}
      });
      const errClose = document.getElementById('errorOverlayClose');
      if (errClose) errClose.addEventListener('click', () => {
        const overlay = document.getElementById('errorOverlay');
        if (overlay) overlay.classList.add('hidden');
      });

      // Wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        // DOM is already loaded
        initializeApp();
      }
      
      // Ensure at least one view is visible on load
      window.addEventListener('load', () => {
        const activeView = document.querySelector('.view.active');
        if (!activeView) {
          // If no view is active, activate the default home view
          const homeView = document.getElementById('view-home');
          if (homeView) {
            homeView.classList.add('active');
          }
        }
      });
    </script>
  </body>
</html>
</html>